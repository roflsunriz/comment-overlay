# Nico 互換モード 設計チェックリスト

このチェックリストは `nico-compat.md` の分析結果を実装へ落とし込むための実行用タスクリストです。各項目は「設計・実装・検証（受け入れ条件）」の3観点で進めます。

凡例: [ ] 未着手 / [~] 着手中 / [x] 完了

## デフォルト設定のニコニコ互換化

- [x] デフォルト設定をニコニコ互換に変更（横断4s固定、RTL固定、不透明1.0、影なし、DPR対応ON、描画順固定、固定レーン数可）
  - 設計: `RendererSettings` の既定値をニコニコ互換の挙動になるように直接変更する。プリセットや切り替え機構は設けない。
  - 実装: `src/config/default-settings.ts` の値をニコニコ互換仕様に更新し、互換プロファイル等の切り替え機構を設けない。
  - 検証: 各設定値がニコニコ互換の仕様通りになっていることを確認する。

## 時間同期・タイミング精度

- [x] `vpos`（1/100秒）→ ms の厳密変換・評価（シーク/倍速耐性）
  - 実装位置: `src/core/comment-renderer.ts`（時間評価/有効化窓）, 入力層。
  - 受け入れ: 秒→ms変換誤差が±5ms以内。シーク直後の活性化が安定。

- [x] `requestVideoFrameCallback` 同期モードの追加（対応環境のみ）
  - 実装位置: アニメーションフレーム供給抽象（`AnimationFrameProvider` 拡張）。
  - 受け入れ: 対応ブラウザでフレーム境界同期、RAFと切り替え可能。

## スクロールモデル互換

- [x] RTL をデフォルトにする（切替は可能）
  - 実装位置: `RendererSettings.scrollDirection` の既定値を `"rtl"` にする。
  - 受け入れ: デフォルトでRTLでスクロールし、設定でLTRにも変更できる。

- [x] スクロール可視時間 4s 固定（テキスト幅非依存）
  - 実装位置: `Comment.prepare` / `buildPrepareOptions` の可視時間計算ロジックを4秒固定に統一。
  - 受け入れ: どの幅でも横断時間が約4000msになる。

- [x] レーン衝突回避は速度調整で誤魔化さず、等式解で維持
  - 実装位置: 既存の解法維持（`areReservationsConflicting` 周辺）。
  - 受け入れ: 数式ベースでの判定が維持される。

## 静止（上/下）コメント

- [x] 静止の既定表示 4s・中央寄せ
  - 実装位置: 既存の `STATIC_VISIBLE_DURATION_MS = 4000` を維持。
  - 受け入れ: 4s・中央寄せが維持される。

- [x] 重なり回避（上は上から、下は下から詰め）
  - 実装位置: 既存 `assignStaticLane` の優先順を仕様通りに確認/固定。
  - 受け入れ: 多発時も方向別に安定配置。

## フォントと文字組

- [x] OS別フォントスタック整備（メトリクス互換優先）
  - 実装位置: `src/core/comment-commands.ts` の `FONT_FAMILY_MAP` 見直し。
  - 受け入れ: 主要OSで字幅/行高の差が視認上許容範囲内。

- [x] 改行（\n）対応と折り返しなしの多行描画
  - 実装位置: `src/core/comment.ts` 描画系に multi-line レイアウト追加。
  - 受け入れ: `\n` を含む職人アートが崩れない。行高は固定。

- [x] 字送り（letter-spacing）制御（±px 単位）
  - 実装位置: 文字単位の測定/積み上げ描画モード。
  - 受け入れ: ±px 指定で詰め/ばらしが再現。

- [x] 行送り（line-height）制御
  - 実装位置: multi-line の行間可変パラメータ。
  - 受け入れ: 作品に応じた行間調整が可能。

## 描画スタイル

- [x] デフォルトで影/グロー無しの「純正風（黒縁のみ）」にする
  - 実装位置: `Comment.draw` の描画ロジックを黒縁のみに修正。影の描画コードは削除または無効化。
  - 受け入れ: コメントの影が描画されず、黒縁のみになる。

- [x] DPI 対応（devicePixelRatio）と整数座標スナップ
  - 実装位置: `CommentRenderer.resize` とキャンバス実ピクセル倍率調整。
  - 受け入れ: 高DPIで文字が滲まず、座標端数が出ない。

## コマンド互換

- [x] 既存の `naka/ue/shita`, `small/medium/big`, `defont/gothic/mincho`, 色名/Hex の確認
  - 実装位置: 既存（`src/core/comment-commands.ts`）。
  - 受け入れ: 代表ケースで意図通りに反映。

- [x] 拡張色名や曖昧パース（句読点除去等）の検証
  - 実装位置: 既存ロジックの回帰確認。
  - 受け入れ: `white2` 等が再現、前後句読点は無害化。

## レーン設計

- [x] 固定レーン数の設定入口
  - 実装位置: `RendererSettings` に `useFixedLaneCount`/`fixedLaneCount` を追加し、`calculateLaneMetrics` で反映。
  - 受け入れ: 固定ON時は利用可能レーン数の範囲で固定値が適用。

## 描画順の安定化

- [x] 同時刻多発時の安定した描画順（例: vpos昇順→静止優先→挿入順）
  - 実装位置: `draw()` 前の並べ替え規則を明示化。
  - 受け入れ: 同一 vpos の重なり順が揺れない。

## パフォーマンス/スケーラビリティ

- [x] シーク時の一括再初期化・ちらつき抑制
  - 実装位置: 既存 `onSeek` 後の再活性化フロー見直し。
  - 受け入れ: 大量コメントでも安定。

- [ ] OffscreenCanvas/レイヤ分離の検討（任意）
  - 実装位置: 実験フラグ。将来項目。
  - 受け入れ: CPU負荷/GCの改善が確認できる。

---

初期スコープとしては「固定レーン数の設定入口（完了）」「NicoCompat プリセットの足場」「描画順安定化」「4s固定スクロール」「DPI対応」を優先実装します。
