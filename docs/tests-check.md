# パフォーマンス改善後 テストチェックリスト

各改善項目を適用した後、リグレッション（機能低下・不具合）が発生していないかを確認するためのテスト項目。

## 全般的な確認事項

- [ ] **(基本動作)** コメントが指定した `vposMs` で正しく表示され、流れ終わる（または消える）こと。
- [ ] **(設定変更)** `updateSettings` で設定（色、不透明度、表示/非表示など）を変更した際、即座に描画へ反映されること。
- [ ] **(動画操作)** 動画の再生、一時停止、シーク、再生速度の変更を行っても、コメントの表示が追従し、破綻しないこと。
- [ ] **(リソース)** 大量（例: 5万件以上）のコメントを読み込んでも、ブラウザがクラッシュせず、CPU使用率が過度に上昇しないこと。
- [ ] **(コンソール)** 開発者ツールのコンソールにエラーや意図しない警告ログが出力されていないこと。

---

## Step 1: 低リスク改善項目 チェックリスト

### 1. 状態変更のバッチング (`settingsVersion`)
- [ ] **設定反映:** `updateSettings` で `commentColor` や `commentOpacity` を変更した際、次のフレームで描画に反映されるか。
- [ ] **NGワード/正規表現:** `ngWords`, `ngRegexps` を実行中に変更した場合、以降に追加されるコメントや、再描画されるコメントに正しく適用されるか。
- [ ] **動的フィルタリング:** `isNGComment` が `updateComments` 内で呼ばれる場合、設定変更が既存コメントにも反映されるか。

### 2. `measureText` のキャッシュ
- [ ] **描画精度:** 同じテキスト内容のコメントが、異なるタイミングで表示されても全く同じ幅で描画されるか。
- [ ] **フォント変更:** `fontSize` や `fontFamily` が変わるコメント（`big`, `small` コマンドなど）や、`letterSpacing` が指定されたコメントが正しい幅で描画されるか。
- [ ] **設定変更追従:** `useDprScaling` の変更や `resize` イベント後など、`ctx.font` が変わりうる操作の後で、キャッシュが適切に無効化（または別キーで保存）され、正しい幅で再計算・描画されるか。
- [ ] **複数行コメント:** `\n` を含むコメントの各行が正しく計測され、折り返しや全体の高さが正常であるか。

### 3. NG判定の事前コンパイル
- [ ] **NG機能:** NGワード、NG正規表現が正しく機能し、対象コメントが非表示になるか。
- [ ] **設定更新:** `updateSettings` で `ngRegexps` を動的に追加・削除した際、その後のNG判定が正しく行われるか。
- [ ] **不正な正規表現:** `ngRegexps` に不正な正規表現パターンが含まれていても、アプリケーションがクラッシュせず、他の有効なパターンは機能し続けるか。

### 4. 不可視タブでのアニメーション停止
- [ ] **停止/再開:** ブラウザのタブを切り替えて非表示にした際、コメントの描画処理が停止し、CPU使用率が低下するか。
- [ ] **復帰後:** タブを再度表示状態に戻した際、停止した時間分を考慮せず、動画の現在時刻に合わせてコメントが正しい位置から描画再開されるか。

### 5. `sort` 呼び出し回数削減 (バルクAPI)
- [ ] **追加順序:** `addComments` で大量のコメントを追加した後、`vposMs` 順および `creationIndex` 順で正しくソートされているか。
- [ ] **逐次追加との整合性:** `addComment` で1件ずつ追加した場合と、`addComments` でまとめて追加した場合で、最終的なコメントの表示順序や描画結果に差異がないか。

---

## Step 2: 中リスク改善項目 チェックリスト

### 1. 時間インデックス導入 (二分探索)
- [ ] **表示網羅性:** 動画再生中、表示されるべきコメントが1つも欠落していないか。
- [ ] **シーク直後:** 動画の任意の位置にシークした直後、その再生時間周辺のコメント（スクロール中だったものも含む）が正しく再計算され、表示されるか。特に動画の先頭や末尾へのシーク。
- [ ] **境界値:** `ACTIVE_WINDOW_MS` の境界ぎりぎりに `vposMs` を持つコメントが、正しく表示/非表示の対象となるか。
- [ ] **逆再生/逆シーク:** 再生速度をマイナスにしたり、短い距離を逆方向にシークしたりした場合でも、コメントが正しく表示されるか。

### 2. アクティブコメント配列の分離管理
- [ ] **状態遷移:** コメントが表示開始（`isActive = true`）および表示終了（`isActive = false`）するタイミングで、`activeComments` 配列（または `Set`）に正しく追加・削除されるか。
- [ ] **クリア処理:** `clearComments()` や動画ソース変更時に `activeComments` が完全に空になるか。
- [ ] **表示の完全性:** `draw` ループで描画されるコメントと、`isActive` フラグが `true` のコメント群が常に一致しているか。表示されるべきコメントが漏れたり、消えるべきコメントが残ったりしないか。

### 3. レーン予約リストの最適化
- [ ] **衝突回避:** コメントが密集するシーンでも、レーン予約が正しく機能し、コメント同士の衝突が適切に回避されているか。
- [ ] **レーン解放:** コメントが表示範囲から消えた後、そのコメントが確保していたレーン予約が正しく解放され、後続のコメントがそのレーンを利用できるか。
- [ ] **静止コメントとの協調:** `ue`, `shita` コメントによって予約された静的レーンを、`naka` コメントが避けて流れるか。

---

## Step 3: 高リスク改善項目 チェックリスト

### 1. オフスクリーンでのテクスチャ化
- [ ] **描画品質:** テクスチャ化されたコメントと、通常通り `fillText/strokeText` で描画されたコメントで、見た目（フォント、色、アンチエイリアスなど）に差異がないか。
- [ ] **動的変更:** 不透明度や色が変化するコメント（例: `_live` コマンド）がテクスチャ化された場合、その動的な変化が正しく反映されるか。
- [ ] **メモリ管理:** `OffscreenCanvas` のキャッシュが適切に管理され、メモリリークが発生しないか。

### 2. レイアウト計算のWeb Worker化
- [ ] **同期:** メインスレッドとWorker間でのデータ送受信に遅延や競合が発生し、コメントの表示タイミングがずれたり、表示されなくなったりしないか。
- [ ] **状態整合性:** Workerでの計算中にメインスreadで `settings` が変更された場合など、状態の不整合が起きないか。

### 3. `clearRect` の範囲最小化
- [ ] **描画残像:** 以前のフレームの描画がクリアされずに残像として残らないか。特にコメントが消えるときや、半透明のコメントが重なる領域。
- [ ] **全画面クリア:** シーク時や `resize` 時など、全画面の再描画が必要なタイミングでは、確実に全画面クリアが実行されるか。
