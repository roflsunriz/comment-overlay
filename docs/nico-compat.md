了解。comment-overlay のソースをざっと精読したうえで、「ニコニコの職人アートを再現するために必須になる要素」を、現状実装と差分を意識して指摘します（コード差分や疑似コードは出しません／ファイル参照のみ）。

---

# まず “職人再現” に必要な要素（要件セット）

* **タイミング精度**

  * 動画フレームと同期（`requestVideoFrameCallback` 利用可なら優先）。フレーム境界での出現・退場の再現性が鍵。
  * `vpos`（ニコでは1/100秒単位）→ ms への確実な変換と、シーク・倍速でも破綻しない再評価。
  * “同一時刻に大量出現” 時の**安定した描画順**（表示順規則の固定）。

* **スクロールモデルの互換性**

  * 右→左（RTL）固定の**互換モード**。
  * スクロール可視時間は **一定（約4s）** の互換規則（テキスト幅に関わらず横断時間は一定）。
  * 衝突回避（レーン確保）は**元仕様に近い条件**で行い、速度調整で誤魔化さない。

* **静止（上/下）コメントの挙動**

  * 既定の可視時間（約4s）、**中央寄せ**、重なり回避のルール（上は上から詰め、下は下から詰め）。
  * 同時多発時の差し替え・追い出し規則の安定化。

* **フォントと文字組（これが最重要）**

  * 既定フォント（歴史的には *MS Pゴシック* 相当）の**メトリクス互換**。
  * 全角/半角の幅、句読点・記号の形、CJKグリフ差を**OS差込みで吸収**（Windows/Mac/Linux）。
  * **文字送り（letter-spacing）** と **行送り（line-height）** の制御（職人は詰め/空きを前提に絵を組む）。
  * **改行（`\n`）の多行描画**と、折り返しなし（固定行高）レンダリング。

* **描画スタイル（見た目の互換）**

  * **太い黒縁**（内側塗り潰しは不透明 1.0 が基本）。
  * 影やグローの有無を切り替え（“純正風” と “今風” をトグル）。
  * DPI（devicePixelRatio）対応の**クリスプなテキスト**（DPRスケール＋整数座標スナップ）。

* **コマンド互換**

  * `naka/ue/shita`、`big/medium/small`、`defont/gothic/mincho`、色名＋`#RRGGBB` の解釈。
  * 一部職人が使う「`white2` などの拡張色名」「半角区切りの曖昧パース」「`invisible` 的な透明化」。
  * 上記の**前後の句読点除去**など “ゆるい” パースも必要。

* **レーン設計**

  * 画面高とフォントサイズからの**レーン自動数**（典型 16 レーン）＋**固定指定の入口**も用意。
  * レーン予約の**数式ベースの衝突判定**（等式解で交差時刻を求めるアプローチは妥当）。

* **パフォーマンス/スケーラビリティ**

  * 同時数千コメントでも GC/レイアウトを抑える（OffscreenCanvas/レイヤ分離の選択肢）。
  * シーク時の**一括再初期化**と描画のワンスルー確定（ちらつき対策）。

* **入力アダプタ**

  * ニコの JSON/CSV 風フォーマット（`vpos`, `mail`/`command`, 本文）→エンジン内部形式の**堅牢な変換**。
  * NG ワード/正規表現、表示/非表示切替、左右方向のグローバル設定。

---

# 現状ソースで **できている**／互換性に効いている点 (v1.1.0)

* **レイアウト/サイズ/フォント/色コマンド**の基本系

  * `naka/ue/shita`・`small/medium/big`・`defont/gothic/mincho`・色名＋16進（3/4/6/8桁）を解釈。
    `src/core/comment-commands.ts:17-24,26-48,49-56,72-91`
  * 拡張色（`white2` など）も実装済み。`src/core/comment-commands.ts:72-91`
  * 先頭/末尾の句読点除去など**ゆるいトークン化**あり。`src/core/comment-commands.ts:58-70`

* **透明化系およびライブ用**

  * `_live`（半透明）・`invisible`（完全非表示）を認識。`src/core/comment-commands.ts:134-141`

* **静止コメントの 4 秒**

  * `STATIC_VISIBLE_DURATION_MS = 4000`。`src/core/comment.ts:8`
  * 静止は中央寄せ。`src/core/comment.ts:201-206`

* **スクロールの衝突回避（レーン予約）**

  * 可視時間/距離から速度算出→**衝突時刻の解析解**で判定。
    `src/core/comment-renderer.ts:610-618, 832-920` 付近

* **レーン数の自動計算（典型 16 レーン）**

  * 画面高×5%を基準フォント、行高=×1.2、割り算でレーン数決定。
    `src/core/comment-renderer.ts:485-492, 54-55`

* **描画の “黒縁＋塗り”**（見た目は近い）

  * 黒ストローク→多段シャドウ→塗り。
    `src/core/comment.ts:346-354, 361-389, 391-399`

* **NG ワード/正規表現**

  * `ngWords` / `ngRegexps` を両方評価。`src/core/comment-renderer.ts:368-414`

* **リサイズ/フルスクリーン対応**

  * video の `getBoundingClientRect()`、スケール追従、座標と速度の再スケール。
    `src/core/comment-renderer.ts:422-452, 14054-14078`

* **フレーム補間**

  * `requestAnimationFrame` ベース＋**描画側での速度補間**。
    `src/core/comment-renderer.ts:69-86, 950-955`

---

# **不足/差異が大きい** ため “職人再現” で問題になり得る点

* **(A) フォント互換（最重要）**

  * 既定 `defont/gothic/mincho` のフォントスタックに **MS Pゴシック相当** が無い（Windows 前提でもずれる）。
    `src/core/comment-commands.ts:17-24`
  * 職人作は**字幅/行間/記号の形**まで織り込み済み。等幅ではなく *特定プロポーショナル* 前提の作品も多い。
    ⇒ “Nico互換フォントスタック” を OS 別に用意（Win: `MS PGothic` 優先、Mac: 代替候補、Linux: Noto + 調整）。
    ⇒ **メトリクス固定モード**（letter-spacing/line-height を指定可能）を追加。

* **(B) 可視時間モデルが “純正” とズレる**

  * 現状は **長文ほど可視時間を短縮**（幅比で 4s を短縮→最小 1.8s）。
    `src/core/comment.ts:245-254, 256-268`（`MAX_VISIBLE_DURATION_MS=4000`, `MIN_VISIBLE_DURATION_MS=1800` は `src/core/comment-renderer.ts:46-47`）
  * ニコの体感は「**横断時間が一定（≈4s）**」。長文ほど速く流れる＝結果として**可視時間は一定**に近い。
    ⇒ 「**Nico互換（横断4s固定）モード**」を別立てにし、現状の“幅で短縮”は別モードに切り出す。

* **(C) 多行/行送りが無い**

  * `fillText()` 一発描画で `\n` は未対応、行送り制御も無し。
    `測定: src/core/comment.ts:196-204 / 描画: 391-399`
    ⇒ **改行サポート**と**固定行高**（レーンとは別の“行”概念）を追加。職人の絵文字アートで必須。

* **(D) 文字送り（トラッキング）調整が無い**

  * `letter-spacing` 相当の実装が無く、詰め/ばらしで絵作りする職人作が崩れる。
    ⇒ 1 文字ずつ測定して x 進行を足すモード（概念）を用意し、**±px 単位**で可変化。

* **(E) DPI 非対応による滲み**

  * `devicePixelRatio` を見ずに CSS px をキャンバス px に直書き。
    `src/core/comment-renderer.ts:422-452, 13350-14078`（DPR 拡大処理なし）
    ⇒ DPR でキャンバス物理解像度を拡大し、**整数座標スナップ**を徹底（横1pxブレがアートを崩す）。

* **(F) 描画順の安定規則が未固定**

  * `activeComments.forEach` は**配列順依存**。同時刻多発で順序が揺れる余地。
    `src/core/comment-renderer.ts:946-955`
    ⇒ 「**vpos昇順→静止優先/同時刻は挿入順**」などの**明示ルール**を固定（職人は重なり順も設計する）。

* **(G) 影/グローが“強い”**

  * 影を多段で重ねる現在の絵作りは**純正より派手**。
    `src/core/comment.ts:352-389`
    ⇒ **“純正風（黒縁のみ）”スタイル**のトグルを用意（作品によって切り替え）。

* **(H) RTL/LTR の切替はあるが互換既定が LTR に寄らないように**

  * `scrollDirection` は設定で切替可（既定は `"rtl"` だが、互換モード固定が安全）。
    `src/shared/types.ts:10, src/core/comment-renderer.ts:34-40`

* **(I) Video フレーム同期が RAF のみ**

  * `requestAnimationFrame` ベース。映像デコードとズレる可能性。
    `src/core/comment-renderer.ts:69-86`
    ⇒ `requestVideoFrameCallback`（ある環境で）へ切替可能な**同期モード**を追加。

* **(J) 既定不透明度が 0.75**

  * 職人アートは**不透明 1.0**前提が多い。
    `src/config/default-settings.ts:16`
    ⇒ 互換プリセットでは **1.0** を既定に。

* **(K) レーン数の手動固定が無い**

  * 自動計算は良いが、作品によっては **固定16** が前提。
    `src/core/comment-renderer.ts:485-492`
    ⇒ **固定レーン数**の設定入口を用意。

---

# まとめ（行動指針）

* **互換プリセットを 1 個作る**（“NicoCompat”）

  * 横断4s固定・RTL固定・不透明1.0・黒縁（影なし）・DPR対応ON・描画順ルール固定・レーン数固定可。
* **フォント基盤の刷新**

  * OS 別スタック＋メトリクス固定（必要なら WebFont 代替と letter-spacing/line-height 補正）。
* **文字組 API の拡張**

  * 改行/行送り/字送りを per-comment で制御可能に（コマンド or フィールド）
* **同期の強化**

  * `requestVideoFrameCallback` 対応＆ vpos→ms 変換の厳密化。

この4点を押さえると、職人系アートの“崩れ”が一気に減ります。必要なら、上の各項目について設計チェックリスト（検証観点）も出します。
