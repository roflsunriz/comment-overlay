"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const oe={debug:0,info:1,warn:2,error:3},Ce=(l,e,t)=>{const s=[`[${e}]`,...t];switch(l){case"debug":console.debug(...s);break;case"info":console.info(...s);break;case"warn":console.warn(...s);break;case"error":console.error(...s);break;default:console.log(...s)}},te=(l,e={})=>{const{level:t="info",emitter:i=Ce}=e,s=oe[t],n=(a,r)=>{oe[a]<s||i(a,l,r)};return{debug:(...a)=>n("debug",a),info:(...a)=>n("info",a),warn:(...a)=>n("warn",a),error:(...a)=>n("error",a)}},xe={small:.8,medium:1,big:1.4},we={defont:'"MS PGothic","Hiragino Kaku Gothic ProN","Hiragino Kaku Gothic Pro","Yu Gothic UI","Yu Gothic","Meiryo","Segoe UI","Osaka","Noto Sans CJK JP","Noto Sans JP","Source Han Sans JP","IPAPGothic","TakaoPGothic","Roboto","Helvetica Neue","Helvetica","Arial","sans-serif"',gothic:'"Noto Sans CJK JP","Noto Sans JP","Source Han Sans JP","Yu Gothic","Yu Gothic Medium","Meiryo","MS PGothic","Hiragino Kaku Gothic ProN","Segoe UI","Helvetica","Arial","sans-serif"',mincho:'"MS PMincho","MS Mincho","Hiragino Mincho ProN","Hiragino Mincho Pro","Yu Mincho","Noto Serif CJK JP","Noto Serif JP","Source Han Serif JP","Times New Roman","serif"'},ve={white:"#FFFFFF",red:"#FF0000",pink:"#FF8080",orange:"#FF9900",yellow:"#FFFF00",green:"#00FF00",cyan:"#00FFFF",blue:"#0000FF",purple:"#C000FF",black:"#000000",white2:"#CC9",red2:"#C03",pink2:"#F3C",orange2:"#F60",yellow2:"#990",green2:"#0C6",cyan2:"#0CC",blue2:"#39F",purple2:"#63C",black2:"#666"},ie=/^#([0-9a-f]{3}|[0-9a-f]{4}|[0-9a-f]{6}|[0-9a-f]{8})$/i,Te=/^[,.:;]+/,Ee=/[,.:;]+$/,Le=l=>{const e=l.trim();return e?ie.test(e)?e:e.replace(Te,"").replace(Ee,""):""},Pe=l=>ie.test(l)?l.toUpperCase():null,ge=l=>{const e=l.trim();if(!e)return null;const t=e.toLowerCase().endsWith("px")?e.slice(0,-2):e,i=Number.parseFloat(t);return Number.isFinite(i)?i:null},Fe=l=>{const e=l.trim();if(!e)return null;if(e.endsWith("%")){const t=Number.parseFloat(e.slice(0,-1));return Number.isFinite(t)?t/100:null}return ge(e)},De=l=>Number.isFinite(l)?Math.min(100,Math.max(-100,l)):0,Ae=l=>!Number.isFinite(l)||l===0?1:Math.min(5,Math.max(.25,l)),Re=l=>l==="naka"||l==="ue"||l==="shita",Oe=l=>l==="small"||l==="medium"||l==="big",Ve=l=>l==="defont"||l==="gothic"||l==="mincho",Ie=l=>l in ve,Ne=(l,e)=>{let t="naka",i="medium",s="defont",n=null,a=1,r=null,c=!1,d=0,h=1;for(const f of l){const g=Le(typeof f=="string"?f:"");if(!g)continue;if(ie.test(g)){const y=Pe(g);if(y){n=y;continue}}const v=g.toLowerCase();if(Re(v)){t=v;continue}if(Oe(v)){i=v;continue}if(Ve(v)){s=v;continue}if(Ie(v)){n=ve[v].toUpperCase();continue}if(v==="_live"){r=.5;continue}if(v==="invisible"){a=0,c=!0;continue}if(v.startsWith("ls:")||v.startsWith("letterspacing:")){const y=g.indexOf(":");if(y>=0){const b=ge(g.slice(y+1));b!==null&&(d=De(b))}continue}if(v.startsWith("lh:")||v.startsWith("lineheight:")){const y=g.indexOf(":");if(y>=0){const b=Fe(g.slice(y+1));b!==null&&(h=Ae(b))}continue}}const u=Math.max(0,Math.min(1,a)),o=(n??e.defaultColor).toUpperCase(),p=typeof r=="number"?Math.max(0,Math.min(1,r)):null;return{layout:t,size:i,sizeScale:xe[i],font:s,fontFamily:we[s],resolvedColor:o,colorOverride:n,opacityMultiplier:u,opacityOverride:p,isInvisible:c,letterSpacing:d,lineHeight:h}},Q=5,H={enabled:!1,maxLogsPerCategory:Q},W=new Map,He=l=>{if(l===void 0||!Number.isFinite(l))return Q;const e=Math.max(1,Math.floor(l));return Math.min(1e4,e)},me=l=>{H.enabled=!!l.enabled,H.maxLogsPerCategory=He(l.maxLogsPerCategory),H.enabled||W.clear()},ke=()=>{W.clear()},P=()=>H.enabled,ze=l=>{const e=W.get(l)??0;return e>=H.maxLogsPerCategory?(e===H.maxLogsPerCategory&&(console.debug(`[CommentOverlay][${l}]`,"Further logs suppressed."),W.set(l,e+1)),!1):(W.set(l,e+1),!0)},C=(l,...e)=>{H.enabled&&ze(l)&&console.debug(`[CommentOverlay][${l}]`,...e)},R=(l,e=32)=>l.length<=e?l:`${l.slice(0,e)}â€¦`,K=te("CommentEngine:Comment"),le=new WeakMap,_e=l=>{let e=le.get(l);return e||(e=new Map,le.set(l,e)),e},$=(l,e)=>{if(!l)return 0;const i=`${l.font??""}::${e}`,s=_e(l),n=s.get(i);if(n!==void 0)return n;const a=l.measureText(e).width;return s.set(i,a),a},N=4e3,We=/^#([0-9A-F]{3}|[0-9A-F]{4}|[0-9A-F]{6}|[0-9A-F]{8})$/i,he=8,$e=12,F=l=>!Number.isFinite(l)||l<=0?0:l>=1?1:l,X=l=>l.length===1?l.repeat(2):l,O=l=>Number.parseInt(l,16),ce=(l,e)=>{const t=We.exec(l);if(!t)return l;const i=t[1];let s,n,a,r=1;i.length===3||i.length===4?(s=O(X(i[0])),n=O(X(i[1])),a=O(X(i[2])),i.length===4&&(r=O(X(i[3]))/255)):(s=O(i.slice(0,2)),n=O(i.slice(2,4)),a=O(i.slice(4,6)),i.length===8&&(r=O(i.slice(6,8))/255));const c=F(r*F(e));return`rgba(${s}, ${n}, ${a}, ${c})`},Xe=()=>({now:()=>typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}),se=()=>Xe(),Be=l=>l==="ltr"?"ltr":"rtl",Ge=l=>l==="ltr"?1:-1;class m{text;vposMs;commands;layout;isScrolling;sizeScale;opacityMultiplier;opacityOverride;colorOverride;isInvisible;x=0;y=0;width=0;height=0;baseSpeed=0;speed=0;lane=-1;color;fontSize=0;fontFamily;opacity;activationTimeMs=null;staticExpiryTimeMs=null;isActive=!1;hasShown=!1;isPaused=!1;lastUpdateTime=0;reservationWidth=0;bufferWidth=0;visibleDurationMs=0;totalDurationMs=0;preCollisionDurationMs=0;speedPixelsPerMs=0;virtualStartX=0;exitThreshold=0;scrollDirection="rtl";renderStyle="outline-only";creationIndex=0;letterSpacing=0;lineHeightMultiplier=1;lineHeightPx=0;lines=[];directionSign=-1;timeSource;lastSyncedSettingsVersion=-1;cachedTexture=null;textureCacheKey="";constructor(e,t,i,s,n={}){if(typeof e!="string")throw new Error("Comment text must be a string");if(!Number.isFinite(t)||t<0)throw new Error("Comment vposMs must be a non-negative number");this.text=e,this.vposMs=t,this.commands=Array.isArray(i)?[...i]:[];const a=Ne(this.commands,{defaultColor:s.commentColor});this.layout=a.layout,this.isScrolling=this.layout==="naka",this.sizeScale=a.sizeScale,this.opacityMultiplier=a.opacityMultiplier,this.opacityOverride=a.opacityOverride,this.colorOverride=a.colorOverride,this.isInvisible=a.isInvisible,this.fontFamily=a.fontFamily,this.color=a.resolvedColor,this.opacity=this.getEffectiveOpacity(s.commentOpacity),this.renderStyle=s.renderStyle,this.letterSpacing=a.letterSpacing,this.lineHeightMultiplier=a.lineHeight,this.timeSource=n.timeSource??se(),this.applyScrollDirection(s.scrollDirection),this.syncWithSettings(s,n.settingsVersion)}prepare(e,t,i,s){try{if(!e)throw new Error("Canvas context is required");if(!Number.isFinite(t)||!Number.isFinite(i))throw new Error("Canvas dimensions must be numbers");if(!s)throw new Error("Prepare options are required");const n=Math.max(t,1),a=Math.max(24,Math.floor(i*.05)),r=Math.max(24,Math.floor(a*this.sizeScale));this.fontSize=r,e.font=`${this.fontSize}px ${this.fontFamily}`;const c=this.text.includes(`
`)?this.text.split(/\r?\n/):[this.text];this.lines=c.length>0?c:[""],this.updateTextMetrics(e);const d=!this.isScrolling&&(this.layout==="ue"||this.layout==="shita");if(d){const E=Math.max(1,n-he*2);if(this.width>E){const A=Math.max($e,Math.min(this.fontSize,Math.floor(a*.6))),q=E/Math.max(this.width,1),z=Math.max(A,Math.floor(this.fontSize*Math.min(q,1)));z<this.fontSize&&(this.fontSize=z,e.font=`${this.fontSize}px ${this.fontFamily}`,this.updateTextMetrics(e));let ae=0;for(;this.width>E&&this.fontSize>A&&ae<5;){const be=E/Math.max(this.width,1),re=Math.max(A,Math.floor(this.fontSize*Math.max(be,.7)));re>=this.fontSize?this.fontSize=Math.max(A,this.fontSize-1):this.fontSize=re,e.font=`${this.fontSize}px ${this.fontFamily}`,this.updateTextMetrics(e),ae+=1}}}if(!this.isScrolling){this.bufferWidth=0;const E=d?he:0,A=Math.max((n-this.width)/2,E),q=Math.max(E,n-this.width-E),z=Math.min(A,Math.max(q,E));this.virtualStartX=z,this.x=z,this.baseSpeed=0,this.speed=0,this.speedPixelsPerMs=0,this.visibleDurationMs=N,this.preCollisionDurationMs=N,this.totalDurationMs=N,this.reservationWidth=this.width,this.staticExpiryTimeMs=this.vposMs+N,this.lastUpdateTime=this.timeSource.now(),this.isPaused=!1;return}this.staticExpiryTimeMs=null;const h=$(e,"??".repeat(150)),u=this.width*Math.max(s.bufferRatio,0);this.bufferWidth=Math.max(s.baseBufferPx,u);const o=Math.max(s.entryBufferPx,this.bufferWidth),p=this.scrollDirection,f=p==="rtl"?n+s.virtualExtension:-this.width-this.bufferWidth-s.virtualExtension,g=p==="rtl"?-this.width-this.bufferWidth-o:n+o,v=p==="rtl"?n+o:-o,y=p==="rtl"?f+this.width+this.bufferWidth:f-this.bufferWidth;this.virtualStartX=f,this.x=f,this.exitThreshold=g;const b=n>0?this.width/n:0,x=s.maxVisibleDurationMs===s.minVisibleDurationMs;let M=s.maxVisibleDurationMs;if(!x&&b>1){const E=Math.min(b,s.maxWidthRatio),A=s.maxVisibleDurationMs/Math.max(E,1);M=Math.max(s.minVisibleDurationMs,Math.floor(A))}const w=n+this.width+this.bufferWidth+o,S=Math.max(M,1),V=w/S,k=V*1e3/60;this.baseSpeed=k,this.speed=this.baseSpeed,this.speedPixelsPerMs=V;const U=Math.abs(g-f),Y=p==="rtl"?Math.max(0,y-v):Math.max(0,v-y),ne=Math.max(V,Number.EPSILON);this.visibleDurationMs=M,this.preCollisionDurationMs=Math.max(0,Math.ceil(Y/ne)),this.totalDurationMs=Math.max(this.preCollisionDurationMs,Math.ceil(U/ne));const Me=this.width+this.bufferWidth+o;this.reservationWidth=Math.min(h,Me),this.lastUpdateTime=this.timeSource.now(),this.isPaused=!1}catch(n){throw K.error("Comment.prepare",n,{text:this.text,visibleWidth:t,canvasHeight:i,hasContext:!!e}),n}}update(e=1,t=!1){try{if(!this.isActive){this.isPaused=t;return}const i=this.timeSource.now();if(!this.isScrolling){this.isPaused=t,this.lastUpdateTime=i;return}if(t){this.isPaused=!0,this.lastUpdateTime=i;return}const s=(i-this.lastUpdateTime)/(1e3/60);this.speed=this.baseSpeed*e,this.x+=this.speed*s*this.directionSign,(this.scrollDirection==="rtl"&&this.x<=this.exitThreshold||this.scrollDirection==="ltr"&&this.x>=this.exitThreshold)&&(this.isActive=!1),this.lastUpdateTime=i,this.isPaused=!1}catch(i){K.error("Comment.update",i,{text:this.text,playbackRate:e,isPaused:t,isActive:this.isActive})}}generateTextureCacheKey(){return`v2::${this.text}::${this.fontSize}::${this.fontFamily}::${this.color}::${this.opacity}::${this.renderStyle}::${this.letterSpacing}::${this.lines.length}`}static cacheStats={hits:0,misses:0,creates:0,fallbacks:0,outlineCallsInCache:0,fillCallsInCache:0,outlineCallsInFallback:0,fillCallsInFallback:0,letterSpacingComments:0,normalComments:0,multiLineComments:0,totalCharactersDrawn:0,lastReported:0};static reportCacheStats(){if(!P())return;const e=performance.now();if(e-m.cacheStats.lastReported>5e3){const t=m.cacheStats.hits+m.cacheStats.misses,i=t>0?m.cacheStats.hits/t*100:0,s=m.cacheStats.creates>0?(m.cacheStats.totalCharactersDrawn/m.cacheStats.creates).toFixed(1):"0",n=m.cacheStats.outlineCallsInCache+m.cacheStats.outlineCallsInFallback,a=m.cacheStats.fillCallsInCache+m.cacheStats.fillCallsInFallback;console.log("[TextureCache Stats]",`
  Cache: Hits=${m.cacheStats.hits}, Misses=${m.cacheStats.misses}, Hit Rate=${i.toFixed(1)}%`,`
  Creates: ${m.cacheStats.creates}, Fallbacks: ${m.cacheStats.fallbacks}`,`
  Comments: Normal=${m.cacheStats.normalComments}, LetterSpacing=${m.cacheStats.letterSpacingComments}, MultiLine=${m.cacheStats.multiLineComments}`,`
  Draw Calls: Outline=${n}, Fill=${a}`,`
  Avg Characters/Comment: ${s}`),m.cacheStats.lastReported=e}}isOffscreenCanvasSupported(){return typeof OffscreenCanvas<"u"}createTextureCanvas(e){if(!this.isOffscreenCanvasSupported())return null;const t=Math.abs(this.letterSpacing)>=Number.EPSILON,i=this.lines.length>1;t&&m.cacheStats.letterSpacingComments++,i&&m.cacheStats.multiLineComments++,!t&&!i&&m.cacheStats.normalComments++,m.cacheStats.totalCharactersDrawn+=this.text.length;const s=Math.max(10,this.fontSize*.5),n=Math.ceil(this.width+s*2),a=Math.ceil(this.height+s*2),r=new OffscreenCanvas(n,a),c=r.getContext("2d");if(!c)return null;c.save(),c.font=`${this.fontSize}px ${this.fontFamily}`;const d=F(this.opacity),h=s,u=this.lines.length>0?this.lines:[this.text],o=this.lines.length>1&&this.lineHeightPx>0?this.lineHeightPx:this.fontSize,p=s+this.fontSize,f=this.createSegmentDrawer(c,e,"cache",h),g=this.getOutlineOffsets(),v=()=>{const x=F(d*.6);c.save(),c.fillStyle=`rgba(0, 0, 0, ${x})`;for(const[M,w]of g)u.forEach((S,V)=>{const k=p+V*o+w;f(S,k,"outline",M)});c.restore()},y=x=>{c.save(),c.fillStyle=x,u.forEach((M,w)=>{const S=p+w*o;f(M,S,"fill")}),c.restore()};if(v(),this.renderStyle==="classic"){const x=Math.max(1,this.fontSize*.04),M=this.fontSize*.18;[{offsetXMultiplier:.9,offsetYMultiplier:1.1,blurMultiplier:.55,alpha:.52,rgb:"20, 28, 40"},{offsetXMultiplier:2.4,offsetYMultiplier:2.7,blurMultiplier:1.45,alpha:.32,rgb:"0, 0, 0"},{offsetXMultiplier:-.7,offsetYMultiplier:-.6,blurMultiplier:.4,alpha:.42,rgb:"255, 255, 255"}].forEach(S=>{const V=F(S.alpha*d);c.save(),c.shadowColor=`rgba(${S.rgb}, ${V})`,c.shadowBlur=M*S.blurMultiplier,c.shadowOffsetX=x*S.offsetXMultiplier,c.shadowOffsetY=x*S.offsetYMultiplier,c.fillStyle="rgba(0, 0, 0, 0)",u.forEach((k,U)=>{const Y=p+U*o;f(k,Y,"fill")}),c.restore()})}const b=ce(this.color,d);return y(b),c.restore(),r}draw(e,t=null){try{if(!this.isActive||!e)return;const i=this.generateTextureCacheKey();if(this.textureCacheKey!==i||!this.cachedTexture?(m.cacheStats.misses++,m.cacheStats.creates++,this.cachedTexture=this.createTextureCanvas(e),this.textureCacheKey=i):m.cacheStats.hits++,this.cachedTexture){const f=t??this.x,g=Math.max(10,this.fontSize*.5);e.drawImage(this.cachedTexture,f-g,this.y-g),m.reportCacheStats();return}m.cacheStats.fallbacks++,e.save(),e.font=`${this.fontSize}px ${this.fontFamily}`;const s=F(this.opacity),n=t??this.x,a=this.lines.length>0?this.lines:[this.text],r=this.lines.length>1&&this.lineHeightPx>0?this.lineHeightPx:this.fontSize,c=this.y+this.fontSize,d=this.createSegmentDrawer(e,e,"fallback",n),h=this.getOutlineOffsets(),u=()=>{const f=F(s*.6);e.save(),e.fillStyle=`rgba(0, 0, 0, ${f})`;for(const[g,v]of h)a.forEach((y,b)=>{const x=c+b*r+v;d(y,x,"outline",g)});e.restore()},o=f=>{e.save(),e.fillStyle=f,a.forEach((g,v)=>{const y=c+v*r;d(g,y,"fill")}),e.restore()};if(u(),this.renderStyle==="classic"){const f=Math.max(1,this.fontSize*.04),g=this.fontSize*.18;[{offsetXMultiplier:.9,offsetYMultiplier:1.1,blurMultiplier:.55,alpha:.52,rgb:"20, 28, 40"},{offsetXMultiplier:2.4,offsetYMultiplier:2.7,blurMultiplier:1.45,alpha:.32,rgb:"0, 0, 0"},{offsetXMultiplier:-.7,offsetYMultiplier:-.6,blurMultiplier:.4,alpha:.42,rgb:"255, 255, 255"}].forEach(y=>{const b=F(y.alpha*s);e.save(),e.shadowColor=`rgba(${y.rgb}, ${b})`,e.shadowBlur=g*y.blurMultiplier,e.shadowOffsetX=f*y.offsetXMultiplier,e.shadowOffsetY=f*y.offsetYMultiplier,e.fillStyle="rgba(0, 0, 0, 0)",a.forEach((x,M)=>{const w=c+M*r;d(x,w,"fill")}),e.restore()})}const p=ce(this.color,s);o(p),e.restore(),m.reportCacheStats()}catch(i){K.error("Comment.draw",i,{text:this.text,isActive:this.isActive,hasContext:!!e,interpolatedX:t})}}syncWithSettings(e,t){typeof t=="number"&&t===this.lastSyncedSettingsVersion||(this.color=this.getEffectiveColor(e.commentColor),this.opacity=this.getEffectiveOpacity(e.commentOpacity),this.applyScrollDirection(e.scrollDirection),this.renderStyle=e.renderStyle,typeof t=="number"&&(this.lastSyncedSettingsVersion=t))}getEffectiveColor(e){const t=this.colorOverride??e;return typeof t!="string"||t.length===0?e:t.toUpperCase()}getEffectiveOpacity(e){if(typeof this.opacityOverride=="number")return F(this.opacityOverride);const t=e*this.opacityMultiplier;return Number.isFinite(t)?F(t):0}markActivated(e){this.activationTimeMs=e}clearActivation(){this.activationTimeMs=null,this.isScrolling||(this.staticExpiryTimeMs=null),this.cachedTexture=null,this.textureCacheKey=""}hasStaticExpired(e){return this.isScrolling||this.staticExpiryTimeMs===null?!1:e>=this.staticExpiryTimeMs}getDirectionSign(){return this.directionSign}applyScrollDirection(e){const t=Be(e);this.scrollDirection=t,this.directionSign=Ge(t)}createSegmentDrawer(e,t,i,s){return(n,a,r,c=0)=>{if(n.length===0)return;const d=n.match(/^[\u3000\u00A0]+/),h=d?d[0].length:0,u=h>0?$(t,d[0]):0,o=s+u+c,p=h>0?n.substring(h):n,f=()=>{i==="cache"?r==="outline"?m.cacheStats.outlineCallsInCache++:m.cacheStats.fillCallsInCache++:r==="outline"?m.cacheStats.outlineCallsInFallback++:m.cacheStats.fillCallsInFallback++};if(Math.abs(this.letterSpacing)<Number.EPSILON){f(),e.fillText(p,o,a);return}let g=o;for(let v=0;v<p.length;v+=1){const y=p[v];f(),e.fillText(y,g,a);const b=$(t,y);g+=b,v<p.length-1&&(g+=this.letterSpacing)}}}getOutlineOffsets(){const e=Math.max(1,Math.round(this.fontSize*.08)),t=[[-e,0],[e,0],[0,-e],[0,e]];if(e>1){const i=Math.max(1,Math.round(e*.7));t.push([-i,-i],[-i,i],[i,-i],[i,i])}return t}updateTextMetrics(e){let t=0;const i=this.letterSpacing;for(const a of this.lines){const r=$(e,a),c=a.length>1?i*(a.length-1):0,d=Math.max(0,r+c);d>t&&(t=d)}this.width=t;const s=Math.max(1,Math.floor(this.fontSize*this.lineHeightMultiplier));this.lineHeightPx=s;const n=this.lines.length>1?(this.lines.length-1)*s:0;this.height=this.fontSize+n}}const Ue=4e3,G={commentColor:"#FFFFFF",commentOpacity:1,isCommentVisible:!0,useContainerResizeObserver:!0,ngWords:[],ngRegexps:[],scrollDirection:"rtl",renderStyle:"outline-only",syncMode:"raf",scrollVisibleDurationMs:Ue,useFixedLaneCount:!1,fixedLaneCount:12,useDprScaling:!0},Ye=G,Se=()=>({...G,ngWords:[...G.ngWords],ngRegexps:[...G.ngRegexps]}),qe="v2.4.1",L=l=>l*1e3,Ke=l=>!Number.isFinite(l)||l<0?null:Math.round(l),ee=4e3,ue=1800,Je=3,je=.25,Ze=32,Qe=48,J=120,et=4e3,j=120,tt=800,it=2,_=4e3,D=N+ee,st=1e3,de=1,fe=12,pe=24,T=.001,I=50,nt=.05,at=10,rt=l=>Number.isFinite(l)?l<=0?0:l>=1?1:l:1,Z=l=>Math.max(at,Math.floor(l*nt)),B=l=>{const e=l.scrollVisibleDurationMs,t=e==null?null:Number.isFinite(e)?Math.max(1,Math.floor(e)):null;return{...l,scrollDirection:l.scrollDirection==="ltr"?"ltr":"rtl",commentOpacity:rt(l.commentOpacity),renderStyle:l.renderStyle==="classic"?"classic":"outline-only",scrollVisibleDurationMs:t,syncMode:l.syncMode==="video-frame"?"video-frame":"raf",useDprScaling:!!l.useDprScaling}},ye=l=>typeof window<"u"&&typeof window.requestAnimationFrame=="function"&&typeof window.cancelAnimationFrame=="function"?{request:e=>window.requestAnimationFrame(e),cancel:e=>window.cancelAnimationFrame(e)}:{request:e=>globalThis.setTimeout(()=>{e(l.now())},16),cancel:e=>{globalThis.clearTimeout(e)}},ot=()=>typeof document>"u"?()=>{throw new Error("Document is not available. Provide a custom createCanvasElement implementation.")}:()=>document.createElement("canvas"),lt=l=>{if(!l||typeof l!="object")return!1;const e=l;return typeof e.commentColor=="string"&&typeof e.commentOpacity=="number"&&typeof e.isCommentVisible=="boolean"};class ht{_settings;comments=[];activeComments=new Set;reservedLanes=new Map;topStaticLaneReservations=[];bottomStaticLaneReservations=[];log;timeSource;animationFrameProvider;createCanvasElement;commentDependencies;settingsVersion=0;normalizedNgWords=[];compiledNgRegexps=[];canvas=null;ctx=null;videoElement=null;containerElement=null;fullscreenActive=!1;laneCount=fe;laneHeight=0;displayWidth=0;displayHeight=0;canvasDpr=1;currentTime=0;duration=0;playbackRate=1;isPlaying=!0;isStalled=!1;lastDrawTime=0;finalPhaseActive=!1;finalPhaseStartTime=null;finalPhaseScheduleDirty=!1;playbackHasBegun=!1;skipDrawingForCurrentFrame=!1;pendingInitialSync=!1;finalPhaseVposOverrides=new Map;frameId=null;videoFrameHandle=null;resizeObserver=null;resizeObserverTarget=null;isResizeObserverAvailable=typeof ResizeObserver<"u";cleanupTasks=[];commentSequence=0;constructor(e=null,t=void 0){let i,s;if(lt(e))i=B({...e}),s=t??{};else{const n=e??t??{};s=typeof n=="object"?n:{},i=B(Se())}this._settings=B(i),this.timeSource=s.timeSource??se(),this.animationFrameProvider=s.animationFrameProvider??ye(this.timeSource),this.createCanvasElement=s.createCanvasElement??ot(),this.commentDependencies={timeSource:this.timeSource,settingsVersion:this.settingsVersion},this.log=te(s.loggerNamespace??"CommentRenderer"),this.rebuildNgMatchers(),s.debug&&me(s.debug)}get settings(){return this._settings}set settings(e){this._settings=B(e),this.settingsVersion+=1,this.commentDependencies.settingsVersion=this.settingsVersion,this.rebuildNgMatchers()}resolveContainer(e,t){if(e)return e;if(t.parentElement)return t.parentElement;if(typeof document<"u"&&document.body)return document.body;throw new Error("Cannot resolve container element. Provide container explicitly when DOM is unavailable.")}ensureContainerPositioning(e){if(typeof getComputedStyle=="function"){getComputedStyle(e).position==="static"&&(e.style.position="relative");return}e.style.position||(e.style.position="relative")}initialize(e){try{this.destroyCanvasOnly();const t=e instanceof HTMLVideoElement?e:e.video,i=e instanceof HTMLVideoElement?e.parentElement:e.container??e.video.parentElement,s=this.resolveContainer(i??null,t);this.videoElement=t,this.containerElement=s,this.duration=Number.isFinite(t.duration)?L(t.duration):0,this.currentTime=L(t.currentTime),this.playbackRate=t.playbackRate,this.isPlaying=!t.paused,this.isStalled=!1,this.lastDrawTime=this.timeSource.now(),this.playbackHasBegun=this.isPlaying||this.currentTime>I,this.skipDrawingForCurrentFrame=this.shouldSuppressRendering();const n=this.createCanvasElement(),a=n.getContext("2d");if(!a)throw new Error("Failed to acquire 2D canvas context");n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.pointerEvents="none",n.style.zIndex="1000";const r=this.containerElement;r instanceof HTMLElement&&(this.ensureContainerPositioning(r),r.appendChild(n)),this.canvas=n,this.ctx=a,this.resize(),this.calculateLaneMetrics(),this.setupVideoEventListeners(t),this.setupResizeHandling(t),this.setupFullscreenHandling(),this.setupVideoChangeDetection(t,s),this.startAnimation(),this.setupVisibilityHandling()}catch(t){throw this.log.error("CommentRenderer.initialize",t),t}}addComments(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];this.commentDependencies.settingsVersion=this.settingsVersion;for(const i of e){const{text:s,vposMs:n,commands:a=[]}=i,r=R(s);if(this.isNGComment(s)){C("comment-skip-ng",{preview:r,vposMs:n});continue}const c=Ke(n);if(c===null){this.log.warn("CommentRenderer.addComment.invalidVpos",{text:s,vposMs:n}),C("comment-skip-invalid-vpos",{preview:r,vposMs:n});continue}if(this.comments.some(u=>u.text===s&&u.vposMs===c)||t.some(u=>u.text===s&&u.vposMs===c)){C("comment-skip-duplicate",{preview:r,vposMs:c});continue}const h=new m(s,c,a,this._settings,this.commentDependencies);h.creationIndex=this.commentSequence++,t.push(h),C("comment-added",{preview:r,vposMs:c,commands:h.commands.length,layout:h.layout,isScrolling:h.isScrolling,invisible:h.isInvisible})}return t.length===0?[]:(this.comments.push(...t),this.finalPhaseActive&&(this.finalPhaseScheduleDirty=!0),this.comments.sort((i,s)=>{const n=i.vposMs-s.vposMs;return Math.abs(n)>T?n:i.creationIndex-s.creationIndex}),t)}addComment(e,t,i=[]){const[s]=this.addComments([{text:e,vposMs:t,commands:i}]);return s??null}clearComments(){if(this.comments.length=0,this.activeComments.clear(),this.reservedLanes.clear(),this.topStaticLaneReservations.length=0,this.bottomStaticLaneReservations.length=0,this.commentSequence=0,this.ctx&&this.canvas){const e=this.canvasDpr>0?this.canvasDpr:1,t=this.displayWidth>0?this.displayWidth:this.canvas.width/e,i=this.displayHeight>0?this.displayHeight:this.canvas.height/e;this.ctx.clearRect(0,0,t,i)}}resetState(){this.clearComments(),this.currentTime=0,this.resetFinalPhaseState(),this.playbackHasBegun=!1,this.skipDrawingForCurrentFrame=!1,this.isStalled=!1,this.pendingInitialSync=!1}destroy(){this.stopAnimation(),this.cleanupResizeHandling(),this.runCleanupTasks(),this.canvas&&this.canvas.remove(),this.canvas=null,this.ctx=null,this.videoElement=null,this.containerElement=null,this.comments.length=0,this.activeComments.clear(),this.reservedLanes.clear(),this.resetFinalPhaseState(),this.displayWidth=0,this.displayHeight=0,this.canvasDpr=1,this.commentSequence=0,this.playbackHasBegun=!1,this.skipDrawingForCurrentFrame=!1,this.isStalled=!1,this.pendingInitialSync=!1}hardReset(){const e=this.canvas,t=this.ctx;if(this.activeComments.clear(),this.reservedLanes.clear(),this.topStaticLaneReservations.length=0,this.bottomStaticLaneReservations.length=0,this.comments.forEach(i=>{i.isActive=!1,i.hasShown=!1,i.lane=-1,i.clearActivation()}),e&&t){const i=this.canvasDpr>0?this.canvasDpr:1,s=this.displayWidth>0?this.displayWidth:e.width/i,n=this.displayHeight>0?this.displayHeight:e.height/i;t.clearRect(0,0,s,n)}this.pendingInitialSync=!0,this.resetFinalPhaseState()}resetFinalPhaseState(){this.finalPhaseActive=!1,this.finalPhaseStartTime=null,this.finalPhaseScheduleDirty=!1,this.finalPhaseVposOverrides.clear()}getEffectiveCommentVpos(e){return this.finalPhaseActive&&this.finalPhaseScheduleDirty&&this.recomputeFinalPhaseTimeline(),this.finalPhaseVposOverrides.get(e)??e.vposMs}getFinalPhaseDisplayDuration(e){if(!e.isScrolling)return N;const t=[];return Number.isFinite(e.visibleDurationMs)&&e.visibleDurationMs>0&&t.push(e.visibleDurationMs),Number.isFinite(e.totalDurationMs)&&e.totalDurationMs>0&&t.push(e.totalDurationMs),t.length>0?Math.max(...t):ee}resolveFinalPhaseVpos(e){if(!this.finalPhaseActive||this.finalPhaseStartTime===null)return this.finalPhaseVposOverrides.delete(e),e.vposMs;this.finalPhaseScheduleDirty&&this.recomputeFinalPhaseTimeline();const t=this.finalPhaseVposOverrides.get(e);if(t!==void 0)return t;const i=Math.max(e.vposMs,this.finalPhaseStartTime);return this.finalPhaseVposOverrides.set(e,i),i}recomputeFinalPhaseTimeline(){if(!this.finalPhaseActive||this.finalPhaseStartTime===null){this.finalPhaseVposOverrides.clear(),this.finalPhaseScheduleDirty=!1;return}const e=this.finalPhaseStartTime,t=this.duration>0?this.duration:e+_,i=Math.max(e+_,t),s=this.comments.filter(h=>h.hasShown||h.isInvisible||this.isNGComment(h.text)?!1:h.vposMs>=e-D).sort((h,u)=>{const o=h.vposMs-u.vposMs;return Math.abs(o)>T?o:h.creationIndex-u.creationIndex});if(this.finalPhaseVposOverrides.clear(),s.length===0){this.finalPhaseScheduleDirty=!1;return}const a=Math.max(i-e,_)/Math.max(s.length,1),r=Number.isFinite(a)?a:j,c=Math.max(j,Math.min(r,tt));let d=e;s.forEach((h,u)=>{const o=Math.max(1,this.getFinalPhaseDisplayDuration(h)),p=i-o;let f=Math.max(e,Math.min(d,p));Number.isFinite(f)||(f=e);const g=it*u;f+g<=p&&(f+=g),this.finalPhaseVposOverrides.set(h,f);const v=Math.max(j,Math.min(o/2,c));d=f+v}),this.finalPhaseScheduleDirty=!1}shouldSuppressRendering(){return!this.playbackHasBegun&&!this.isPlaying&&this.currentTime<=I}updatePlaybackProgressState(){this.playbackHasBegun||(this.isPlaying||this.currentTime>I)&&(this.playbackHasBegun=!0)}updateSettings(e){const t=this._settings.useContainerResizeObserver,i=this._settings.scrollDirection,s=this._settings.useDprScaling,n=this._settings.syncMode;this.settings=e;const a=i!==this._settings.scrollDirection,r=s!==this._settings.useDprScaling,c=n!==this._settings.syncMode;if(this.comments.forEach(d=>{d.syncWithSettings(this._settings,this.settingsVersion)}),a&&this.resetCommentActivity(),!this._settings.isCommentVisible&&this.ctx&&this.canvas){this.comments.forEach(o=>{o.isActive=!1,o.clearActivation()}),this.activeComments.clear();const d=this.canvasDpr>0?this.canvasDpr:1,h=this.displayWidth>0?this.displayWidth:this.canvas.width/d,u=this.displayHeight>0?this.displayHeight:this.canvas.height/d;this.ctx.clearRect(0,0,h,u),this.reservedLanes.clear(),this.topStaticLaneReservations.length=0,this.bottomStaticLaneReservations.length=0}t!==this._settings.useContainerResizeObserver&&this.videoElement&&this.setupResizeHandling(this.videoElement),r&&this.resize(),c&&this.videoElement&&this.startAnimation(),this.calculateLaneMetrics()}getVideoElement(){return this.videoElement}getCurrentVideoSource(){const e=this.videoElement;if(!e)return null;if(typeof e.currentSrc=="string"&&e.currentSrc.length>0)return e.currentSrc;const t=e.getAttribute("src");if(t&&t.length>0)return t;const i=e.querySelector("source[src]");return i&&typeof i.src=="string"?i.src:null}getCommentsSnapshot(){return[...this.comments]}rebuildNgMatchers(){const e=[],t=[],i=Array.isArray(this._settings.ngWords)?this._settings.ngWords:[];for(const n of i){if(typeof n!="string")continue;const a=n.trim().toLowerCase();a.length!==0&&e.push(a)}const s=Array.isArray(this._settings.ngRegexps)?this._settings.ngRegexps:[];for(const n of s)if(!(typeof n!="string"||n.length===0))try{t.push(new RegExp(n))}catch(a){this.log.error("CommentRenderer.rebuildNgMatchers.regex",a,{pattern:n})}this.normalizedNgWords=e,this.compiledNgRegexps=t}isNGComment(e){try{if(typeof e!="string")return!0;if(this.normalizedNgWords.length>0){const t=e.toLowerCase();if(this.normalizedNgWords.some(s=>t.includes(s)))return!0}return this.compiledNgRegexps.length>0?this.compiledNgRegexps.some(t=>t.test(e)):!1}catch(t){return this.log.error("CommentRenderer.isNGComment",t,{text:e}),!0}}resize(e,t){const i=this.videoElement,s=this.canvas,n=this.ctx;if(!i||!s)return;const a=i.getBoundingClientRect(),r=this.canvasDpr>0?this.canvasDpr:1,c=this.displayWidth>0?this.displayWidth:s.width/r,d=this.displayHeight>0?this.displayHeight:s.height/r,h=e??a.width??c,u=t??a.height??d;if(!Number.isFinite(h)||!Number.isFinite(u)||h<=0||u<=0)return;const o=Math.max(1,Math.floor(h)),p=Math.max(1,Math.floor(u)),f=this.displayWidth>0?this.displayWidth:o,g=this.displayHeight>0?this.displayHeight:p,v=this._settings.useDprScaling?this.resolveDevicePixelRatio():1,y=Math.max(1,Math.round(o*v)),b=Math.max(1,Math.round(p*v));if(!(this.displayWidth!==o||this.displayHeight!==p||Math.abs(this.canvasDpr-v)>Number.EPSILON||s.width!==y||s.height!==b))return;this.displayWidth=o,this.displayHeight=p,this.canvasDpr=v,s.width=y,s.height=b,s.style.width=`${o}px`,s.style.height=`${p}px`,n&&(n.setTransform(1,0,0,1,0,0),this._settings.useDprScaling&&n.scale(v,v));const M=f>0?o/f:1,w=g>0?p/g:1;(M!==1||w!==1)&&this.comments.forEach(S=>{S.isActive&&(S.x*=M,S.y*=w,S.width*=M,S.fontSize=Math.max(pe,Math.floor(Math.max(1,S.fontSize)*w)),S.height=S.fontSize,S.virtualStartX*=M,S.exitThreshold*=M,S.baseSpeed*=M,S.speed*=M,S.speedPixelsPerMs*=M,S.bufferWidth*=M,S.reservationWidth*=M)}),this.calculateLaneMetrics()}resolveDevicePixelRatio(){if(typeof window>"u")return 1;const e=Number(window.devicePixelRatio);return!Number.isFinite(e)||e<=0?1:e}destroyCanvasOnly(){this.stopAnimation(),this.cleanupResizeHandling(),this.runCleanupTasks(),this.canvas&&this.canvas.remove(),this.canvas=null,this.ctx=null,this.displayWidth=0,this.displayHeight=0,this.canvasDpr=1,this.fullscreenActive=!1}calculateLaneMetrics(){const e=this.canvas;if(!e)return;const t=this.displayHeight>0?this.displayHeight:e.height/Math.max(this.canvasDpr,1),i=Math.max(pe,Math.floor(t*.05));this.laneHeight=i*1.2;const s=Math.floor(t/Math.max(this.laneHeight,1));if(this._settings.useFixedLaneCount){const n=Number.isFinite(this._settings.fixedLaneCount)?Math.floor(this._settings.fixedLaneCount):fe,a=Math.max(de,Math.min(s,n));this.laneCount=a}else this.laneCount=Math.max(de,s);this.topStaticLaneReservations.length=0,this.bottomStaticLaneReservations.length=0}updateComments(e){const t=this.videoElement,i=this.canvas,s=this.ctx;if(!t||!i||!s)return;const n=typeof e=="number"?e:L(t.currentTime);if(this.currentTime=n,this.playbackRate=t.playbackRate,this.isPlaying=!t.paused,this.updatePlaybackProgressState(),this.skipDrawingForCurrentFrame=this.shouldSuppressRendering(),this.skipDrawingForCurrentFrame)return;const a=this.canvasDpr>0?this.canvasDpr:1,r=this.displayWidth>0?this.displayWidth:i.width/a,c=this.displayHeight>0?this.displayHeight:i.height/a,d=this.buildPrepareOptions(r),h=this.duration>0&&this.duration-this.currentTime<=et;h&&!this.finalPhaseActive&&(this.finalPhaseActive=!0,this.finalPhaseStartTime=this.currentTime,this.finalPhaseVposOverrides.clear(),this.finalPhaseScheduleDirty=!0,s.clearRect(0,0,r,c),this.comments.forEach(o=>{o.isActive=!1,o.clearActivation()}),this.activeComments.clear(),this.reservedLanes.clear(),this.topStaticLaneReservations.length=0,this.bottomStaticLaneReservations.length=0),!h&&this.finalPhaseActive&&this.resetFinalPhaseState(),this.finalPhaseActive&&this.finalPhaseScheduleDirty&&this.recomputeFinalPhaseTimeline(),this.pruneStaticLaneReservations(this.currentTime);const u=this.getCommentsInTimeWindow(this.currentTime,D);for(const o of u){const p=P(),f=p?R(o.text):"";if(p&&C("comment-evaluate",{stage:"update",preview:f,vposMs:o.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(o),currentTime:this.currentTime,isActive:o.isActive,hasShown:o.hasShown}),this.isNGComment(o.text)){p&&C("comment-eval-skip",{preview:f,vposMs:o.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(o),reason:"ng-runtime"});continue}if(o.isInvisible){p&&C("comment-eval-skip",{preview:f,vposMs:o.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(o),reason:"invisible"}),o.isActive=!1,this.activeComments.delete(o),o.hasShown=!0,o.clearActivation();continue}if(o.syncWithSettings(this._settings,this.settingsVersion),this.shouldActivateCommentAtTime(o,this.currentTime,f)&&this.activateComment(o,s,r,c,d,this.currentTime),o.isActive){if(o.layout!=="naka"&&o.hasStaticExpired(this.currentTime)){const g=o.layout==="ue"?"ue":"shita";this.releaseStaticLane(g,o.lane),o.isActive=!1,this.activeComments.delete(o),o.clearActivation();continue}if(o.layout==="naka"&&this.getEffectiveCommentVpos(o)>this.currentTime+I){o.x=o.virtualStartX,o.lastUpdateTime=this.timeSource.now();continue}if(o.hasShown=!0,o.update(this.playbackRate,!this.isPlaying),!o.isScrolling&&o.hasStaticExpired(this.currentTime)){const g=o.layout==="ue"?"ue":"shita";this.releaseStaticLane(g,o.lane),o.isActive=!1,this.activeComments.delete(o),o.clearActivation()}}}for(const o of this.comments)o.isActive&&o.isScrolling&&(o.scrollDirection==="rtl"&&o.x<=o.exitThreshold||o.scrollDirection==="ltr"&&o.x>=o.exitThreshold)&&(o.isActive=!1,this.activeComments.delete(o),o.clearActivation())}buildPrepareOptions(e){const t=this._settings.scrollVisibleDurationMs;let i=ee,s=ue;return t!==null&&(i=t,s=Math.max(1,Math.min(t,ue))),{visibleWidth:e,virtualExtension:st,maxVisibleDurationMs:i,minVisibleDurationMs:s,maxWidthRatio:Je,bufferRatio:je,baseBufferPx:Ze,entryBufferPx:Qe}}findAvailableLane(e){const t=this.currentTime;this.pruneLaneReservations(t),this.pruneStaticLaneReservations(t);const i=this.getLanePriorityOrder(t),s=this.createLaneReservation(e,t);for(const a of i)if(this.isLaneAvailable(a,s,t))return this.storeLaneReservation(a,s),a;const n=i[0]??0;return this.storeLaneReservation(n,s),n}findFirstValidReservationIndex(e,t){let i=0,s=e.length;for(;i<s;){const n=Math.floor((i+s)/2),a=e[n];a!==void 0&&a.totalEndTime+J<=t?i=n+1:s=n}return i}pruneLaneReservations(e){for(const[t,i]of this.reservedLanes.entries()){const s=this.findFirstValidReservationIndex(i,e);s>=i.length?this.reservedLanes.delete(t):s>0&&this.reservedLanes.set(t,i.slice(s))}}pruneStaticLaneReservations(e){const t=n=>n.filter(a=>a.releaseTime>e),i=t(this.topStaticLaneReservations),s=t(this.bottomStaticLaneReservations);this.topStaticLaneReservations.length=0,this.topStaticLaneReservations.push(...i),this.bottomStaticLaneReservations.length=0,this.bottomStaticLaneReservations.push(...s)}findCommentIndexAtOrAfter(e){let t=0,i=this.comments.length;for(;t<i;){const s=Math.floor((t+i)/2),n=this.comments[s];n!==void 0&&n.vposMs<e?t=s+1:i=s}return t}getCommentsInTimeWindow(e,t){if(this.comments.length===0)return[];const i=e-t,s=e+t,n=this.findCommentIndexAtOrAfter(i),a=[];for(let r=n;r<this.comments.length;r++){const c=this.comments[r];if(c===void 0||c.vposMs>s)break;a.push(c)}return a}getStaticReservations(e){return e==="ue"?this.topStaticLaneReservations:this.bottomStaticLaneReservations}getStaticLaneDepth(e){const t=this.getStaticReservations(e);if(t.length===0)return 0;let i=-1;for(const s of t)s.lane>i&&(i=s.lane);return Math.max(0,i+1)}getStaticLaneLimit(e){const t=e==="ue"?"shita":"ue",i=this.getStaticLaneDepth(t),s=this.laneCount-i;return s<=0?-1:s-1}getGlobalLaneIndexForBottom(e){const t=Math.max(1,this.laneCount),i=Math.max(0,e);return Math.max(0,t-1-i)}resolveStaticCommentOffset(e,t,i,s){const n=Math.max(1,i),a=Math.max(s.height,s.fontSize),r=Z(s.fontSize);if(e==="ue"){const h=t*this.laneHeight,u=r,o=Math.max(r,n-a-r);return Math.max(u,Math.min(h,o))}const d=n-t*this.laneHeight-a-r;return Math.max(r,d)}getStaticReservedLaneSet(){const e=new Set;for(const t of this.topStaticLaneReservations)e.add(t.lane);for(const t of this.bottomStaticLaneReservations)e.add(this.getGlobalLaneIndexForBottom(t.lane));return e}shouldActivateCommentAtTime(e,t,i=""){const s=i.length>0&&P(),n=this.resolveFinalPhaseVpos(e);return this.finalPhaseActive&&this.finalPhaseStartTime!==null&&e.vposMs<this.finalPhaseStartTime-T?(s&&C("comment-eval-skip",{preview:i,vposMs:e.vposMs,effectiveVposMs:n,reason:"final-phase-trimmed",finalPhaseStartTime:this.finalPhaseStartTime}),this.finalPhaseVposOverrides.delete(e),!1):e.isInvisible?(s&&C("comment-eval-skip",{preview:i,vposMs:e.vposMs,effectiveVposMs:n,reason:"invisible"}),!1):e.isActive?(s&&C("comment-eval-skip",{preview:i,vposMs:e.vposMs,effectiveVposMs:n,reason:"already-active"}),!1):n>t+I?(s&&C("comment-eval-pending",{preview:i,vposMs:e.vposMs,effectiveVposMs:n,reason:"future",currentTime:t}),!1):n<t-D?(s&&C("comment-eval-skip",{preview:i,vposMs:e.vposMs,effectiveVposMs:n,reason:"expired-window",currentTime:t}),!1):(s&&C("comment-eval-ready",{preview:i,vposMs:e.vposMs,effectiveVposMs:n,currentTime:t}),!0)}activateComment(e,t,i,s,n,a){e.prepare(t,i,s,n);const r=this.resolveFinalPhaseVpos(e);if(P()&&C("comment-prepared",{preview:R(e.text),layout:e.layout,isScrolling:e.isScrolling,width:e.width,height:e.height,bufferWidth:e.bufferWidth,visibleDurationMs:e.visibleDurationMs,effectiveVposMs:r}),e.layout==="naka"){const u=Math.max(0,a-r),o=e.speedPixelsPerMs*u;if(this.finalPhaseActive&&this.finalPhaseStartTime!==null){const b=this.duration>0?this.duration:this.finalPhaseStartTime+_,x=Math.max(this.finalPhaseStartTime+_,b),M=Math.abs(e.exitThreshold-e.virtualStartX),w=x-r;if(w>0&&M>0){const S=M/w;S>e.speedPixelsPerMs&&(e.speedPixelsPerMs=S,e.baseSpeed=S*(1e3/60),e.speed=e.baseSpeed,e.totalDurationMs=Math.ceil(M/S))}}const p=e.getDirectionSign(),f=e.virtualStartX+p*o,g=e.exitThreshold,v=e.scrollDirection;if(v==="rtl"&&f<=g||v==="ltr"&&f>=g){e.isActive=!1,this.activeComments.delete(e),e.hasShown=!0,e.clearActivation(),e.lane=-1,P()&&C("comment-skip-exited",{preview:R(e.text),vposMs:e.vposMs,effectiveVposMs:r,referenceTime:a});return}e.lane=this.findAvailableLane(e),e.y=e.lane*this.laneHeight,e.x=f,e.isActive=!0,this.activeComments.add(e),e.hasShown=!0,e.isPaused=!this.isPlaying,e.markActivated(a),e.lastUpdateTime=this.timeSource.now(),P()&&C("comment-activate-scroll",{preview:R(e.text),lane:e.lane,startX:e.x,width:e.width,visibleDurationMs:e.visibleDurationMs,effectiveVposMs:r});return}const c=r+N;if(a>c){e.isActive=!1,this.activeComments.delete(e),e.hasShown=!0,e.clearActivation(),e.lane=-1,P()&&C("comment-skip-expired",{preview:R(e.text),vposMs:e.vposMs,effectiveVposMs:r,referenceTime:a,displayEnd:c});return}const d=e.layout==="ue"?"ue":"shita",h=this.assignStaticLane(d,e,s,a);e.lane=h,e.y=this.resolveStaticCommentOffset(d,h,s,e),e.x=e.virtualStartX,e.isActive=!0,this.activeComments.add(e),e.hasShown=!0,e.isPaused=!this.isPlaying,e.markActivated(a),e.lastUpdateTime=this.timeSource.now(),e.staticExpiryTimeMs=c,this.reserveStaticLane(d,e,h,c),P()&&C("comment-activate-static",{preview:R(e.text),lane:e.lane,position:d,displayEnd:c,effectiveVposMs:r})}assignStaticLane(e,t,i,s){const n=this.getStaticReservations(e),a=this.getStaticLaneLimit(e),r=a>=0?a+1:0,c=Array.from({length:r},(u,o)=>o);for(const u of c){const o=this.resolveStaticCommentOffset(e,u,i,t),p=Math.max(t.height,t.fontSize),f=Z(t.fontSize),g=o-f,v=o+p+f;if(!n.some(b=>b.releaseTime>s?!(v<=b.yStart||g>=b.yEnd):!1))return u}let d=c[0]??0,h=Number.POSITIVE_INFINITY;for(const u of n)u.releaseTime<h&&(h=u.releaseTime,d=u.lane);return d}reserveStaticLane(e,t,i,s){const n=this.getStaticReservations(e),a=Math.max(t.height,t.fontSize),r=Z(t.fontSize),c=t.y-r,d=t.y+a+r;n.push({comment:t,releaseTime:s,yStart:c,yEnd:d,lane:i})}releaseStaticLane(e,t){if(t<0)return;const i=this.getStaticReservations(e),s=i.findIndex(n=>n.lane===t);s>=0&&i.splice(s,1)}getLanePriorityOrder(e){const i=Array.from({length:this.laneCount},(r,c)=>c).sort((r,c)=>{const d=this.getLaneNextAvailableTime(r,e),h=this.getLaneNextAvailableTime(c,e);return Math.abs(d-h)<=T?r-c:d-h}),s=this.getStaticReservedLaneSet();if(s.size===0)return i;const n=i.filter(r=>!s.has(r));if(n.length===0)return i;const a=i.filter(r=>s.has(r));return[...n,...a]}getLaneNextAvailableTime(e,t){const i=this.reservedLanes.get(e);if(!i||i.length===0)return t;const s=this.findFirstValidReservationIndex(i,t);let n=t;for(let a=s;a<i.length;a++){const r=i[a];r!==void 0&&(n=Math.max(n,r.endTime))}return n}createLaneReservation(e,t){const i=Math.max(e.speedPixelsPerMs,T),s=this.getEffectiveCommentVpos(e),n=Number.isFinite(s)?s:t,a=Math.max(0,n),r=a+e.preCollisionDurationMs+J,c=a+e.totalDurationMs+J;return{comment:e,startTime:a,endTime:Math.max(a,r),totalEndTime:Math.max(a,c),startLeft:e.virtualStartX,width:e.width,speed:i,buffer:e.bufferWidth,directionSign:e.getDirectionSign()}}isLaneAvailable(e,t,i){const s=this.reservedLanes.get(e);if(!s||s.length===0)return!0;const n=this.findFirstValidReservationIndex(s,i);for(let a=n;a<s.length;a++){const r=s[a];if(r===void 0)break;if(this.areReservationsConflicting(r,t))return!1}return!0}storeLaneReservation(e,t){const s=[...this.reservedLanes.get(e)??[],t].sort((n,a)=>n.totalEndTime-a.totalEndTime);this.reservedLanes.set(e,s)}areReservationsConflicting(e,t){const i=Math.max(e.startTime,t.startTime),s=Math.min(e.endTime,t.endTime);if(i>=s)return!1;const n=new Set([i,s,i+(s-i)/2]),a=this.solveLeftRightEqualityTime(e,t);a!==null&&a>=i-T&&a<=s+T&&n.add(a);const r=this.solveLeftRightEqualityTime(t,e);r!==null&&r>=i-T&&r<=s+T&&n.add(r);for(const c of n){if(c<i-T||c>s+T)continue;const d=this.computeForwardGap(e,t,c),h=this.computeForwardGap(t,e,c);if(d<=T&&h<=T)return!0}return!1}computeForwardGap(e,t,i){const s=this.getBufferedEdges(e,i),n=this.getBufferedEdges(t,i);return s.left-n.right}getBufferedEdges(e,t){const i=Math.max(0,t-e.startTime),s=e.speed*i,n=e.startLeft+e.directionSign*s,a=n-e.buffer,r=n+e.width+e.buffer;return{left:a,right:r}}solveLeftRightEqualityTime(e,t){const i=e.directionSign,s=t.directionSign,n=s*t.speed-i*e.speed;if(Math.abs(n)<T)return null;const r=(t.startLeft+s*t.speed*t.startTime+t.width+t.buffer-e.startLeft-i*e.speed*e.startTime+e.buffer)/n;return Number.isFinite(r)?r:null}draw(){const e=this.canvas,t=this.ctx;if(!e||!t)return;const i=this.canvasDpr>0?this.canvasDpr:1,s=this.displayWidth>0?this.displayWidth:e.width/i,n=this.displayHeight>0?this.displayHeight:e.height/i,a=this.timeSource.now();if(this.skipDrawingForCurrentFrame||this.shouldSuppressRendering()||this.isStalled){t.clearRect(0,0,s,n),this.lastDrawTime=a;return}t.clearRect(0,0,s,n);const r=Array.from(this.activeComments);if(this._settings.isCommentVisible){const c=(a-this.lastDrawTime)/16.666666666666668;r.sort((d,h)=>{const u=this.getEffectiveCommentVpos(d),o=this.getEffectiveCommentVpos(h),p=u-o;return Math.abs(p)>T?p:d.isScrolling!==h.isScrolling?d.isScrolling?1:-1:d.creationIndex-h.creationIndex}),r.forEach(d=>{const u=this.isPlaying&&!d.isPaused?d.x+d.getDirectionSign()*d.speed*c:d.x;d.draw(t,u)})}this.lastDrawTime=a}performInitialSync(e){const t=this.videoElement,i=this.canvas,s=this.ctx;if(!t||!i||!s)return;const n=typeof e=="number"?e:L(t.currentTime);this.currentTime=n,this.lastDrawTime=this.timeSource.now();const a=this.canvasDpr>0?this.canvasDpr:1,r=this.displayWidth>0?this.displayWidth:i.width/a,c=this.displayHeight>0?this.displayHeight:i.height/a,d=this.buildPrepareOptions(r);this.getCommentsInTimeWindow(this.currentTime,D).forEach(u=>{if(this.isNGComment(u.text)||u.isInvisible){u.isActive=!1,this.activeComments.delete(u),u.clearActivation();return}if(u.syncWithSettings(this._settings,this.settingsVersion),u.isActive=!1,this.activeComments.delete(u),u.lane=-1,u.clearActivation(),this.shouldActivateCommentAtTime(u,this.currentTime)){this.activateComment(u,s,r,c,d,this.currentTime);return}this.getEffectiveCommentVpos(u)<this.currentTime-D?u.hasShown=!0:u.hasShown=!1})}processFrame(e){this.videoElement&&this._settings.isCommentVisible&&(this.pendingInitialSync&&(this.performInitialSync(e),this.pendingInitialSync=!1),this.updateComments(e),this.draw())}handleAnimationFrame=()=>{const e=this.frameId;this.frameId=null,e!==null&&this.animationFrameProvider.cancel(e),this.processFrame(),this.scheduleNextFrame()};handleVideoFrame=(e,t)=>{this.videoFrameHandle=null;const i=typeof t?.mediaTime=="number"?t.mediaTime*1e3:void 0;this.processFrame(typeof i=="number"?i:void 0),this.scheduleNextFrame()};shouldUseVideoFrameCallback(){if(this._settings.syncMode!=="video-frame")return!1;const e=this.videoElement;return!!e&&typeof e.requestVideoFrameCallback=="function"&&typeof e.cancelVideoFrameCallback=="function"}scheduleNextFrame(){const e=this.videoElement;if(e){if(this.shouldUseVideoFrameCallback()){this.cancelAnimationFrameRequest(),this.cancelVideoFrameCallback();const t=e.requestVideoFrameCallback;typeof t=="function"&&(this.videoFrameHandle=t.call(e,this.handleVideoFrame));return}this.cancelVideoFrameCallback(),this.frameId=this.animationFrameProvider.request(this.handleAnimationFrame)}}cancelAnimationFrameRequest(){this.frameId!==null&&(this.animationFrameProvider.cancel(this.frameId),this.frameId=null)}cancelVideoFrameCallback(){if(this.videoFrameHandle===null)return;const e=this.videoElement;e&&typeof e.cancelVideoFrameCallback=="function"&&e.cancelVideoFrameCallback(this.videoFrameHandle),this.videoFrameHandle=null}startAnimation(){this.stopAnimation(),this.scheduleNextFrame()}stopAnimation(){this.cancelAnimationFrameRequest(),this.cancelVideoFrameCallback()}onSeek(){const e=this.canvas,t=this.ctx,i=this.videoElement;if(!e||!t||!i)return;const s=L(i.currentTime);this.currentTime=s,this.resetFinalPhaseState(),this.updatePlaybackProgressState(),this.activeComments.clear(),this.reservedLanes.clear(),this.topStaticLaneReservations.length=0,this.bottomStaticLaneReservations.length=0;const n=this.canvasDpr>0?this.canvasDpr:1,a=this.displayWidth>0?this.displayWidth:e.width/n,r=this.displayHeight>0?this.displayHeight:e.height/n,c=this.buildPrepareOptions(a);this.getCommentsInTimeWindow(this.currentTime,D).forEach(h=>{const u=P(),o=u?R(h.text):"";if(u&&C("comment-evaluate",{stage:"seek",preview:o,vposMs:h.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(h),currentTime:this.currentTime,isActive:h.isActive,hasShown:h.hasShown}),this.isNGComment(h.text)){u&&C("comment-eval-skip",{preview:o,vposMs:h.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(h),reason:"ng-runtime"}),h.isActive=!1,this.activeComments.delete(h),h.clearActivation();return}if(h.isInvisible){u&&C("comment-eval-skip",{preview:o,vposMs:h.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(h),reason:"invisible"}),h.isActive=!1,this.activeComments.delete(h),h.hasShown=!0,h.clearActivation();return}if(h.syncWithSettings(this._settings,this.settingsVersion),h.isActive=!1,this.activeComments.delete(h),h.lane=-1,h.clearActivation(),this.shouldActivateCommentAtTime(h,this.currentTime,o)){this.activateComment(h,t,a,r,c,this.currentTime);return}this.getEffectiveCommentVpos(h)<this.currentTime-D?h.hasShown=!0:h.hasShown=!1}),this._settings.isCommentVisible&&(this.lastDrawTime=this.timeSource.now(),this.draw())}setupVideoEventListeners(e){try{const t=()=>{this.isPlaying=!0,this.playbackHasBegun=!0;const p=this.timeSource.now();this.lastDrawTime=p,this.pendingInitialSync||this.hardReset(),this.comments.forEach(f=>{f.lastUpdateTime=p,f.isPaused=!1})},i=()=>{this.isPlaying=!1;const p=this.timeSource.now();this.comments.forEach(f=>{f.lastUpdateTime=p,f.isPaused=!0})},s=()=>{this.onSeek()},n=()=>{this.onSeek()},a=()=>{this.playbackRate=e.playbackRate;const p=this.timeSource.now();this.comments.forEach(f=>{f.lastUpdateTime=p})},r=()=>{this.handleVideoMetadataLoaded(e)},c=()=>{this.duration=Number.isFinite(e.duration)?L(e.duration):0},d=()=>{this.handleVideoSourceChange()},h=()=>{this.handleVideoStalled()},u=()=>{this.handleVideoCanPlay()},o=()=>{this.handleVideoCanPlay()};e.addEventListener("play",t),e.addEventListener("pause",i),e.addEventListener("seeking",s),e.addEventListener("seeked",n),e.addEventListener("ratechange",a),e.addEventListener("loadedmetadata",r),e.addEventListener("durationchange",c),e.addEventListener("emptied",d),e.addEventListener("waiting",h),e.addEventListener("canplay",u),e.addEventListener("playing",o),this.addCleanup(()=>e.removeEventListener("play",t)),this.addCleanup(()=>e.removeEventListener("pause",i)),this.addCleanup(()=>e.removeEventListener("seeking",s)),this.addCleanup(()=>e.removeEventListener("seeked",n)),this.addCleanup(()=>e.removeEventListener("ratechange",a)),this.addCleanup(()=>e.removeEventListener("loadedmetadata",r)),this.addCleanup(()=>e.removeEventListener("durationchange",c)),this.addCleanup(()=>e.removeEventListener("emptied",d)),this.addCleanup(()=>e.removeEventListener("waiting",h)),this.addCleanup(()=>e.removeEventListener("canplay",u)),this.addCleanup(()=>e.removeEventListener("playing",o))}catch(t){throw this.log.error("CommentRenderer.setupVideoEventListeners",t),t}}handleVideoMetadataLoaded(e){this.handleVideoSourceChange(e),this.resize(),this.calculateLaneMetrics(),this.hardReset(),this.onSeek()}handleVideoStalled(){const e=this.canvas,t=this.ctx;if(!e||!t)return;this.isStalled=!0;const i=this.canvasDpr>0?this.canvasDpr:1,s=this.displayWidth>0?this.displayWidth:e.width/i,n=this.displayHeight>0?this.displayHeight:e.height/i;t.clearRect(0,0,s,n),this.comments.forEach(a=>{a.isActive&&(a.lastUpdateTime=this.timeSource.now())})}handleVideoCanPlay(){this.isStalled&&(this.isStalled=!1,this.videoElement&&(this.currentTime=L(this.videoElement.currentTime),this.isPlaying=!this.videoElement.paused),this.lastDrawTime=this.timeSource.now())}handleVideoSourceChange(e){const t=e??this.videoElement;if(!t){this.isPlaying=!1,this.resetFinalPhaseState(),this.resetCommentActivity();return}this.syncVideoState(t),this.resetFinalPhaseState(),this.resetCommentActivity()}syncVideoState(e){this.duration=Number.isFinite(e.duration)?L(e.duration):0,this.currentTime=L(e.currentTime),this.playbackRate=e.playbackRate,this.isPlaying=!e.paused,this.isStalled=!1,this.playbackHasBegun=this.isPlaying||this.currentTime>I,this.lastDrawTime=this.timeSource.now()}resetCommentActivity(){const e=this.timeSource.now(),t=this.canvas,i=this.ctx;if(this.resetFinalPhaseState(),this.skipDrawingForCurrentFrame=!1,this.isStalled=!1,this.pendingInitialSync=!1,this.playbackHasBegun=this.isPlaying||this.currentTime>I,t&&i){const s=this.canvasDpr>0?this.canvasDpr:1,n=this.displayWidth>0?this.displayWidth:t.width/s,a=this.displayHeight>0?this.displayHeight:t.height/s;i.clearRect(0,0,n,a)}this.reservedLanes.clear(),this.topStaticLaneReservations.length=0,this.bottomStaticLaneReservations.length=0,this.comments.forEach(s=>{s.isActive=!1,s.isPaused=!this.isPlaying,s.hasShown=!1,s.lane=-1,s.x=s.virtualStartX,s.speed=s.baseSpeed,s.lastUpdateTime=e,s.clearActivation()}),this.activeComments.clear()}setupVideoChangeDetection(e,t){if(typeof MutationObserver>"u"){this.log.debug("MutationObserver is not available in this environment. Video change detection is disabled.");return}const i=new MutationObserver(n=>{for(const a of n){if(a.type==="attributes"&&a.attributeName==="src"){const r=a.target;let c=null,d=null;if((r instanceof HTMLVideoElement||r instanceof HTMLSourceElement)&&(c=typeof a.oldValue=="string"?a.oldValue:null,d=r.getAttribute("src")),c===d)continue;this.handleVideoSourceChange(e);return}if(a.type==="childList"){for(const r of a.addedNodes)if(r instanceof HTMLSourceElement){this.handleVideoSourceChange(e);return}for(const r of a.removedNodes)if(r instanceof HTMLSourceElement){this.handleVideoSourceChange(e);return}}}});i.observe(e,{attributes:!0,attributeFilter:["src"],attributeOldValue:!0,childList:!0,subtree:!0}),this.addCleanup(()=>i.disconnect());const s=new MutationObserver(n=>{for(const a of n)if(a.type==="childList"){for(const r of a.addedNodes){const c=this.extractVideoElement(r);if(c&&c!==this.videoElement){this.initialize(c);return}}for(const r of a.removedNodes){if(r===this.videoElement){this.videoElement=null,this.handleVideoSourceChange(null);return}if(r instanceof Element){const c=r.querySelector("video");if(c&&c===this.videoElement){this.videoElement=null,this.handleVideoSourceChange(null);return}}}}});s.observe(t,{childList:!0,subtree:!0}),this.addCleanup(()=>s.disconnect())}extractVideoElement(e){if(e instanceof HTMLVideoElement)return e;if(e instanceof Element){const t=e.querySelector("video");if(t instanceof HTMLVideoElement)return t}return null}setupVisibilityHandling(){if(typeof document>"u"||typeof document.addEventListener!="function"||typeof document.removeEventListener!="function")return;const e=()=>{if(document.visibilityState!=="visible"){this.stopAnimation();return}this._settings.isCommentVisible&&(this.handleVisibilityRestore(),this.startAnimation())};document.addEventListener("visibilitychange",e),this.addCleanup(()=>document.removeEventListener("visibilitychange",e)),document.visibilityState!=="visible"&&this.stopAnimation()}handleVisibilityRestore(){const e=this.canvas,t=this.ctx,i=this.videoElement;if(!e||!t||!i)return;this.currentTime=L(i.currentTime),this.isPlaying=!i.paused,this.activeComments.clear(),this.reservedLanes.clear(),this.topStaticLaneReservations.length=0,this.bottomStaticLaneReservations.length=0;const s=this.canvasDpr>0?this.canvasDpr:1,n=this.displayWidth>0?this.displayWidth:e.width/s,a=this.displayHeight>0?this.displayHeight:e.height/s;t.clearRect(0,0,n,a);const r=this.buildPrepareOptions(n),c=this.timeSource.now();this.getCommentsInTimeWindow(this.currentTime,D).forEach(h=>{if(this.isNGComment(h.text)||h.isInvisible){h.isActive=!1,this.activeComments.delete(h),h.clearActivation();return}h.syncWithSettings(this._settings,this.settingsVersion),h.isActive=!1,this.activeComments.delete(h),h.lane=-1,h.clearActivation(),h.lastUpdateTime=c,this.shouldActivateCommentAtTime(h,this.currentTime)&&this.activateComment(h,t,n,a,r,this.currentTime);const u=this.getEffectiveCommentVpos(h);u<this.currentTime-D?h.hasShown=!0:u>this.currentTime&&(h.hasShown=!1)}),this.lastDrawTime=c}setupResizeHandling(e){if(this.cleanupResizeHandling(),this._settings.useContainerResizeObserver&&this.isResizeObserverAvailable){const t=this.resolveResizeObserverTarget(e),i=new ResizeObserver(s=>{for(const n of s){const{width:a,height:r}=n.contentRect;a>0&&r>0?this.resize(a,r):this.resize()}});i.observe(t),this.resizeObserver=i,this.resizeObserverTarget=t}else if(typeof window<"u"&&typeof window.addEventListener=="function"){const t=()=>{this.resize()};window.addEventListener("resize",t),this.addCleanup(()=>window.removeEventListener("resize",t))}else this.log.debug("Resize handling is disabled because neither ResizeObserver nor window APIs are available.")}cleanupResizeHandling(){this.resizeObserver&&this.resizeObserverTarget&&this.resizeObserver.unobserve(this.resizeObserverTarget),this.resizeObserver?.disconnect(),this.resizeObserver=null,this.resizeObserverTarget=null}setupFullscreenHandling(){if(typeof document>"u"||typeof document.addEventListener!="function"||typeof document.removeEventListener!="function")return;const e=()=>{this.handleFullscreenChange()};["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"].forEach(i=>{document.addEventListener(i,e),this.addCleanup(()=>document.removeEventListener(i,e))}),this.handleFullscreenChange()}resolveResizeObserverTarget(e){const t=this.resolveFullscreenContainer(e);return t||(e.parentElement??e)}async handleFullscreenChange(){const e=this.canvas,t=this.videoElement;if(!e||!t)return;const i=this.containerElement??t.parentElement??null,s=this.getFullscreenElement(),n=this.resolveActiveOverlayContainer(t,i,s);if(!(n instanceof HTMLElement))return;e.parentElement!==n?(this.ensureContainerPositioning(n),n.appendChild(e)):this.ensureContainerPositioning(n);const r=(s instanceof HTMLElement&&s.contains(t)?s:null)!==null;this.fullscreenActive!==r&&(this.fullscreenActive=r,this.setupResizeHandling(t)),e.style.position="absolute",e.style.top="0",e.style.left="0",this.resize()}resolveFullscreenContainer(e){const t=this.getFullscreenElement();return t instanceof HTMLElement&&(t===e||t.contains(e))?t:null}resolveActiveOverlayContainer(e,t,i){return i instanceof HTMLElement&&i.contains(e)?i instanceof HTMLVideoElement&&t instanceof HTMLElement?t:i:t??null}getFullscreenElement(){if(typeof document>"u")return null;const e=document;return document.fullscreenElement??e.webkitFullscreenElement??e.mozFullScreenElement??e.msFullscreenElement??null}addCleanup(e){this.cleanupTasks.push(e)}runCleanupTasks(){for(;this.cleanupTasks.length>0;){const e=this.cleanupTasks.pop();try{e?.()}catch(t){this.log.error("CommentRenderer.cleanupTask",t)}}}}exports.COMMENT_OVERLAY_VERSION=qe;exports.Comment=m;exports.CommentRenderer=ht;exports.DEFAULT_RENDERER_SETTINGS=Ye;exports.cloneDefaultSettings=Se;exports.configureDebugLogging=me;exports.createDefaultAnimationFrameProvider=ye;exports.createDefaultTimeSource=se;exports.createLogger=te;exports.debugLog=C;exports.isDebugLoggingEnabled=P;exports.resetDebugCounters=ke;
//# sourceMappingURL=comment-overlay.cjs.js.map
