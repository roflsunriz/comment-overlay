"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const O={debug:0,info:1,warn:2,error:3},G=(o,e,t)=>{const n=[`[${e}]`,...t];switch(o){case"debug":console.debug(...n);break;case"info":console.info(...n);break;case"warn":console.warn(...n);break;case"error":console.error(...n);break;default:console.log(...n)}},L=(o,e={})=>{const{level:t="info",emitter:s=G}=e,n=O[t],r=(i,a)=>{O[i]<n||s(i,o,a)};return{debug:(...i)=>r("debug",i),info:(...i)=>r("info",i),warn:(...i)=>r("warn",i),error:(...i)=>r("error",i)}},Y={small:.8,medium:1,big:1.4},q={defont:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", sans-serif',gothic:'"Noto Sans JP", "Yu Gothic", "Yu Gothic Medium", "Hiragino Kaku Gothic ProN", "Meiryo", "Segoe UI", sans-serif',mincho:'"Noto Serif JP", "Yu Mincho", "Hiragino Mincho ProN", "MS Mincho", "Times New Roman", serif'},N={white:"#FFFFFF",red:"#FF0000",pink:"#FF8080",orange:"#FF9900",yellow:"#FFFF00",green:"#00FF00",cyan:"#00FFFF",blue:"#0000FF",purple:"#C000FF",black:"#000000",white2:"#CC9",red2:"#C03",pink2:"#F3C",orange2:"#F60",yellow2:"#990",green2:"#0C6",cyan2:"#0CC",blue2:"#39F",purple2:"#63C",black2:"#666"},A=/^#([0-9a-f]{3}|[0-9a-f]{4}|[0-9a-f]{6}|[0-9a-f]{8})$/i,$=/^[,.:;]+/,j=/[,.:;]+$/,J=o=>{const e=o.trim();return e?A.test(e)?e:e.replace($,"").replace(j,""):""},K=o=>A.test(o)?o.toUpperCase():null,Z=o=>o==="naka"||o==="ue"||o==="shita",Q=o=>o==="small"||o==="medium"||o==="big",ee=o=>o==="defont"||o==="gothic"||o==="mincho",te=o=>o in N,ie=(o,e)=>{let t="naka",s="medium",n="defont",r=null,i=1,a=null,l=!1;for(const f of o){const p=J(typeof f=="string"?f:"");if(!p)continue;if(A.test(p)){const S=K(p);if(S){r=S;continue}}const u=p.toLowerCase();if(Z(u)){t=u;continue}if(Q(u)){s=u;continue}if(ee(u)){n=u;continue}if(te(u)){r=N[u].toUpperCase();continue}if(u==="_live"){a=.5;continue}u==="invisible"&&(i=0,l=!0)}const h=Math.max(0,Math.min(1,i)),c=(r??e.defaultColor).toUpperCase(),d=typeof a=="number"?Math.max(0,Math.min(1,a)):null;return{layout:t,size:s,sizeScale:Y[s],font:n,fontFamily:q[n],resolvedColor:c,colorOverride:r,opacityMultiplier:h,opacityOverride:d,isInvisible:l}},T=L("CommentEngine:Comment"),y=4e3,se=/^#([0-9A-F]{3}|[0-9A-F]{4}|[0-9A-F]{6}|[0-9A-F]{8})$/i,b=o=>!Number.isFinite(o)||o<=0?0:o>=1?1:o,w=o=>o.length===1?o.repeat(2):o,v=o=>Number.parseInt(o,16),ne=(o,e)=>{const t=se.exec(o);if(!t)return o;const s=t[1];let n,r,i,a=1;s.length===3||s.length===4?(n=v(w(s[0])),r=v(w(s[1])),i=v(w(s[2])),s.length===4&&(a=v(w(s[3]))/255)):(n=v(s.slice(0,2)),r=v(s.slice(2,4)),i=v(s.slice(4,6)),s.length===8&&(a=v(s.slice(6,8))/255));const l=b(a*b(e));return`rgba(${n}, ${r}, ${i}, ${l})`},re=()=>({now:()=>typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}),R=()=>re();class I{text;vpos;commands;layout;isScrolling;sizeScale;opacityMultiplier;opacityOverride;colorOverride;isInvisible;x=0;y=0;width=0;height=0;baseSpeed=0;speed=0;lane=-1;color;fontSize=0;fontFamily;opacity;activationTimeMs=null;staticExpiryTimeMs=null;isActive=!1;hasShown=!1;isPaused=!1;lastUpdateTime=0;reservationWidth=0;bufferWidth=0;visibleDurationMs=0;totalDurationMs=0;preCollisionDurationMs=0;speedPixelsPerMs=0;virtualStartX=0;timeSource;constructor(e,t,s,n,r={}){if(typeof e!="string")throw new Error("Comment text must be a string");if(!Number.isFinite(t)||t<0)throw new Error("Comment vpos must be a non-negative number");this.text=e,this.vpos=t,this.commands=Array.isArray(s)?[...s]:[];const i=ie(this.commands,{defaultColor:n.commentColor});this.layout=i.layout,this.isScrolling=this.layout==="naka",this.sizeScale=i.sizeScale,this.opacityMultiplier=i.opacityMultiplier,this.opacityOverride=i.opacityOverride,this.colorOverride=i.colorOverride,this.isInvisible=i.isInvisible,this.fontFamily=i.fontFamily,this.color=i.resolvedColor,this.opacity=this.getEffectiveOpacity(n.commentOpacity),this.timeSource=r.timeSource??R(),this.syncWithSettings(n)}prepare(e,t,s,n){try{if(!e)throw new Error("Canvas context is required");if(!Number.isFinite(t)||!Number.isFinite(s))throw new Error("Canvas dimensions must be numbers");if(!n)throw new Error("Prepare options are required");const r=Math.max(t,1),i=Math.max(24,Math.floor(s*.05)),a=Math.max(24,Math.floor(i*this.sizeScale));if(this.fontSize=a,e.font=`${this.fontSize}px ${this.fontFamily}`,this.width=e.measureText(this.text).width,this.height=this.fontSize,!this.isScrolling){this.bufferWidth=0;const M=Math.max((r-this.width)/2,0);this.virtualStartX=M,this.x=M,this.baseSpeed=0,this.speed=0,this.speedPixelsPerMs=0,this.visibleDurationMs=y,this.preCollisionDurationMs=y,this.totalDurationMs=y,this.reservationWidth=this.width,this.staticExpiryTimeMs=this.vpos+y,this.lastUpdateTime=this.timeSource.now(),this.isPaused=!1;return}this.staticExpiryTimeMs=null;const l=e.measureText("??".repeat(150)).width,h=this.width*Math.max(n.bufferRatio,0);this.bufferWidth=Math.max(n.baseBufferPx,h);const c=Math.max(n.entryBufferPx,this.bufferWidth);this.virtualStartX=r+n.virtualExtension,this.x=this.virtualStartX;const d=this.width/r;let f=n.maxVisibleDurationMs;if(d>1){const M=Math.min(d,n.maxWidthRatio),B=n.maxVisibleDurationMs/Math.max(M,1);f=Math.max(n.minVisibleDurationMs,Math.floor(B))}const p=r+this.width+this.bufferWidth+c,u=Math.max(f,1),S=p/u,k=S*1e3/60;this.baseSpeed=k,this.speed=this.baseSpeed,this.speedPixelsPerMs=S;const V=this.virtualStartX+this.width+this.bufferWidth+c,H=r+c,U=this.virtualStartX+this.width+this.bufferWidth,x=Math.max(S,Number.EPSILON),W=Math.max(0,U-H);this.visibleDurationMs=f,this.preCollisionDurationMs=Math.max(0,Math.ceil(W/x)),this.totalDurationMs=Math.max(this.preCollisionDurationMs,Math.ceil(V/x));const X=this.width+this.bufferWidth+c;this.reservationWidth=Math.min(l,X),this.lastUpdateTime=this.timeSource.now(),this.isPaused=!1}catch(r){throw T.error("Comment.prepare",r,{text:this.text,visibleWidth:t,canvasHeight:s,hasContext:!!e}),r}}update(e=1,t=!1){try{if(!this.isActive){this.isPaused=t;return}const s=this.timeSource.now();if(!this.isScrolling){this.isPaused=t,this.lastUpdateTime=s;return}if(t){this.isPaused=!0,this.lastUpdateTime=s;return}const n=(s-this.lastUpdateTime)/(1e3/60);this.speed=this.baseSpeed*e,this.x-=this.speed*n,this.x<-this.width&&(this.isActive=!1),this.lastUpdateTime=s,this.isPaused=!1}catch(s){T.error("Comment.update",s,{text:this.text,playbackRate:e,isPaused:t,isActive:this.isActive})}}draw(e,t=null){try{if(!this.isActive||!e)return;e.save(),e.font=`${this.fontSize}px ${this.fontFamily}`;const s=b(this.opacity);e.globalAlpha=s;const n=t??this.x,r=this.y+this.fontSize;e.strokeStyle="#000000",e.lineWidth=Math.max(3,this.fontSize/8),e.lineJoin="round",e.strokeText(this.text,n,r),e.globalAlpha=1;const i=Math.max(1,this.fontSize*.04),a=this.fontSize*.18;[{offsetXMultiplier:.9,offsetYMultiplier:1.1,blurMultiplier:.55,alpha:.52,rgb:"20, 28, 40"},{offsetXMultiplier:2.4,offsetYMultiplier:2.7,blurMultiplier:1.45,alpha:.32,rgb:"0, 0, 0"},{offsetXMultiplier:-.7,offsetYMultiplier:-.6,blurMultiplier:.4,alpha:.42,rgb:"255, 255, 255"}].forEach(h=>{const c=b(h.alpha*s);e.shadowColor=`rgba(${h.rgb}, ${c})`,e.shadowBlur=a*h.blurMultiplier,e.shadowOffsetX=i*h.offsetXMultiplier,e.shadowOffsetY=i*h.offsetYMultiplier,e.fillStyle="rgba(0, 0, 0, 0)",e.fillText(this.text,n,r)}),e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,e.globalAlpha=1,e.fillStyle=ne(this.color,s),e.fillText(this.text,n,r),e.restore()}catch(s){T.error("Comment.draw",s,{text:this.text,isActive:this.isActive,hasContext:!!e,interpolatedX:t})}}syncWithSettings(e){this.color=this.getEffectiveColor(e.commentColor),this.opacity=this.getEffectiveOpacity(e.commentOpacity)}getEffectiveColor(e){const t=this.colorOverride??e;return typeof t!="string"||t.length===0?e:t.toUpperCase()}getEffectiveOpacity(e){if(typeof this.opacityOverride=="number")return b(this.opacityOverride);const t=e*this.opacityMultiplier;return Number.isFinite(t)?b(t):0}markActivated(e){this.activationTimeMs=e}clearActivation(){this.activationTimeMs=null,this.isScrolling||(this.staticExpiryTimeMs=null)}hasStaticExpired(e){return this.isScrolling||this.staticExpiryTimeMs===null?!1:e>=this.staticExpiryTimeMs}}const E={commentColor:"#FFFFFF",commentOpacity:.75,isCommentVisible:!0,useContainerResizeObserver:!0,ngWords:[],ngRegexps:[]},ae=E,z=()=>({...E,ngWords:[...E.ngWords],ngRegexps:[...E.ngRegexps]}),oe="v1.0.1",g=o=>o*1e3,le=1e4,F=2e3,he=1e3,ce=4e3,ue=1800,de=3,fe=.25,me=32,pe=48,C=120,ve=1,ge=12,P=24,m=.001,_=50,D=o=>typeof window<"u"&&typeof window.requestAnimationFrame=="function"&&typeof window.cancelAnimationFrame=="function"?{request:e=>window.requestAnimationFrame(e),cancel:e=>window.cancelAnimationFrame(e)}:{request:e=>globalThis.setTimeout(()=>{e(o.now())},16),cancel:e=>{globalThis.clearTimeout(e)}},Se=()=>typeof document>"u"?()=>{throw new Error("Document is not available. Provide a custom createCanvasElement implementation.")}:()=>document.createElement("canvas"),be=o=>{if(!o||typeof o!="object")return!1;const e=o;return typeof e.commentColor=="string"&&typeof e.commentOpacity=="number"&&typeof e.isCommentVisible=="boolean"};class ye{_settings;comments=[];reservedLanes=new Map;topStaticLaneReservations=new Map;bottomStaticLaneReservations=new Map;log;timeSource;animationFrameProvider;createCanvasElement;commentDependencies;canvas=null;ctx=null;videoElement=null;containerElement=null;laneCount=ge;laneHeight=0;currentTime=0;duration=0;playbackRate=1;isPlaying=!0;lastDrawTime=0;finalPhaseActive=!1;frameId=null;resizeObserver=null;resizeObserverTarget=null;isResizeObserverAvailable=typeof ResizeObserver<"u";cleanupTasks=[];constructor(e=null,t=void 0){let s,n;if(be(e))s={...e},n=t??{};else{const r=e??t??{};n=typeof r=="object"?r:{},s=z()}this.timeSource=n.timeSource??R(),this.animationFrameProvider=n.animationFrameProvider??D(this.timeSource),this.createCanvasElement=n.createCanvasElement??Se(),this.commentDependencies={timeSource:this.timeSource},this._settings={...s},this.log=L(n.loggerNamespace??"CommentRenderer")}get settings(){return this._settings}set settings(e){this._settings={...e}}resolveContainer(e,t){if(e)return e;if(t.parentElement)return t.parentElement;if(typeof document<"u"&&document.body)return document.body;throw new Error("Cannot resolve container element. Provide container explicitly when DOM is unavailable.")}ensureContainerPositioning(e){if(typeof getComputedStyle=="function"){getComputedStyle(e).position==="static"&&(e.style.position="relative");return}e.style.position||(e.style.position="relative")}initialize(e){try{this.destroyCanvasOnly();const t=e instanceof HTMLVideoElement?e:e.video,s=e instanceof HTMLVideoElement?e.parentElement:e.container??e.video.parentElement,n=this.resolveContainer(s??null,t);this.videoElement=t,this.containerElement=n,this.duration=Number.isFinite(t.duration)?g(t.duration):0,this.currentTime=g(t.currentTime),this.playbackRate=t.playbackRate,this.isPlaying=!t.paused,this.lastDrawTime=this.timeSource.now();const r=this.createCanvasElement(),i=r.getContext("2d");if(!i)throw new Error("Failed to acquire 2D canvas context");r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.pointerEvents="none",r.style.zIndex="1000";const a=this.containerElement;a instanceof HTMLElement&&(this.ensureContainerPositioning(a),a.appendChild(r)),this.canvas=r,this.ctx=i,this.resize(),this.calculateLaneMetrics(),this.setupVideoEventListeners(t),this.setupResizeHandling(t),this.setupVideoChangeDetection(t,n),this.startAnimation()}catch(t){throw this.log.error("CommentRenderer.initialize",t),t}}addComment(e,t,s=[]){if(this.isNGComment(e)||this.comments.some(i=>i.text===e&&i.vpos===t))return null;const r=new I(e,t,s,this._settings,this.commentDependencies);return this.comments.push(r),this.comments.sort((i,a)=>i.vpos-a.vpos),r}clearComments(){this.comments.length=0,this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear(),this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}resetState(){this.clearComments(),this.currentTime=0,this.finalPhaseActive=!1}destroy(){this.stopAnimation(),this.cleanupResizeHandling(),this.runCleanupTasks(),this.canvas&&this.canvas.remove(),this.canvas=null,this.ctx=null,this.videoElement=null,this.containerElement=null,this.comments.length=0,this.reservedLanes.clear(),this.finalPhaseActive=!1}updateSettings(e){const t=this._settings.useContainerResizeObserver;this.settings=e,this.comments.forEach(s=>{s.syncWithSettings(this._settings)}),!this._settings.isCommentVisible&&this.ctx&&this.canvas&&(this.comments.forEach(s=>{s.isActive=!1,s.clearActivation()}),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear()),t!==this._settings.useContainerResizeObserver&&this.videoElement&&this.setupResizeHandling(this.videoElement)}getVideoElement(){return this.videoElement}getCurrentVideoSource(){const e=this.videoElement;if(!e)return null;if(typeof e.currentSrc=="string"&&e.currentSrc.length>0)return e.currentSrc;const t=e.getAttribute("src");if(t&&t.length>0)return t;const s=e.querySelector("source[src]");return s&&typeof s.src=="string"?s.src:null}getCommentsSnapshot(){return[...this.comments]}isNGComment(e){try{return typeof e!="string"||Array.isArray(this._settings.ngWords)&&this._settings.ngWords.some(s=>typeof s=="string"&&s.length>0&&e.includes(s))?!0:Array.isArray(this._settings.ngRegexps)?this._settings.ngRegexps.some(t=>{if(typeof t!="string"||t.length===0)return!1;try{return new RegExp(t).test(e)}catch(s){return this.log.error("CommentRenderer.isNGComment.regex",s,{pattern:t,text:e}),!1}}):!1}catch(t){return this.log.error("CommentRenderer.isNGComment",t,{text:e}),!0}}resize(e,t){const s=this.videoElement,n=this.canvas;if(!s||!n)return;const r=s.getBoundingClientRect(),i=e??r.width??n.width,a=t??r.height??n.height;if(!Number.isFinite(i)||!Number.isFinite(a)||i<=0||a<=0)return;const l=Math.max(1,Math.floor(i)),h=Math.max(1,Math.floor(a));if(!Number.isFinite(l)||!Number.isFinite(h))return;const c=n.width||l,d=n.height||h;if(c===l&&d===h)return;n.width=l,n.height=h,n.style.width=`${l}px`,n.style.height=`${h}px`;const f=c>0?l/c:1,p=d>0?h/d:1;(f!==1||p!==1)&&this.comments.forEach(u=>{u.isActive&&(u.x*=f,u.y*=p,u.baseSpeed*=f,u.speed*=f,u.fontSize=Math.max(P,Math.floor(h*.05)))}),this.calculateLaneMetrics()}destroyCanvasOnly(){this.stopAnimation(),this.cleanupResizeHandling(),this.runCleanupTasks(),this.canvas&&this.canvas.remove(),this.canvas=null,this.ctx=null}calculateLaneMetrics(){const e=this.canvas;if(!e)return;const t=Math.max(P,Math.floor(e.height*.05));this.laneHeight=t*1.2;const s=Math.floor(e.height/Math.max(this.laneHeight,1));this.laneCount=Math.max(ve,s),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear()}updateComments(){const e=this.videoElement,t=this.canvas,s=this.ctx;if(!e||!t||!s)return;this.currentTime=g(e.currentTime),this.playbackRate=e.playbackRate,this.isPlaying=!e.paused;const n=this.buildPrepareOptions(t.width),r=this.duration>0&&this.duration-this.currentTime<=le;r&&!this.finalPhaseActive&&(this.finalPhaseActive=!0,s.clearRect(0,0,t.width,t.height),this.comments.forEach(i=>{i.isActive=!1,i.clearActivation()}),this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear()),!r&&this.finalPhaseActive&&(this.finalPhaseActive=!1),this.pruneStaticLaneReservations(this.currentTime);for(const i of this.comments)if(!this.isNGComment(i.text)){if(i.isInvisible){i.isActive=!1,i.hasShown=!0,i.clearActivation();continue}if(i.syncWithSettings(this._settings),this.shouldActivateCommentAtTime(i,this.currentTime)&&this.activateComment(i,s,t.width,t.height,n,this.currentTime),i.isActive){if(i.layout!=="naka"&&i.hasStaticExpired(this.currentTime)){const a=i.layout==="ue"?"ue":"shita";this.releaseStaticLane(a,i.lane),i.isActive=!1,i.clearActivation();continue}if(i.layout==="naka"&&i.vpos>this.currentTime+_){i.x=i.virtualStartX,i.lastUpdateTime=this.timeSource.now();continue}if(i.hasShown=!0,i.update(this.playbackRate,!this.isPlaying),!i.isScrolling&&i.hasStaticExpired(this.currentTime)){const a=i.layout==="ue"?"ue":"shita";this.releaseStaticLane(a,i.lane),i.isActive=!1,i.clearActivation()}}}for(const i of this.comments)i.isActive&&i.isScrolling&&i.x<-i.width&&(i.isActive=!1,i.clearActivation())}buildPrepareOptions(e){return{visibleWidth:e,virtualExtension:he,maxVisibleDurationMs:ce,minVisibleDurationMs:ue,maxWidthRatio:de,bufferRatio:fe,baseBufferPx:me,entryBufferPx:pe}}findAvailableLane(e){const t=this.currentTime;this.pruneLaneReservations(t),this.pruneStaticLaneReservations(t);const s=this.getLanePriorityOrder(t),n=this.createLaneReservation(e,t);for(const i of s)if(this.isLaneAvailable(i,n,t))return this.storeLaneReservation(i,n),i;const r=s[0]??0;return this.storeLaneReservation(r,n),r}pruneLaneReservations(e){for(const[t,s]of this.reservedLanes.entries()){const n=s.filter(r=>r.totalEndTime+C>e);n.length>0?this.reservedLanes.set(t,n):this.reservedLanes.delete(t)}}pruneStaticLaneReservations(e){for(const[t,s]of this.topStaticLaneReservations.entries())s<=e&&this.topStaticLaneReservations.delete(t);for(const[t,s]of this.bottomStaticLaneReservations.entries())s<=e&&this.bottomStaticLaneReservations.delete(t)}getStaticLaneMap(e){return e==="ue"?this.topStaticLaneReservations:this.bottomStaticLaneReservations}getStaticReservedLaneSet(){const e=new Set;for(const t of this.topStaticLaneReservations.keys())e.add(t);for(const t of this.bottomStaticLaneReservations.keys())e.add(t);return e}shouldActivateCommentAtTime(e,t){return!(e.isInvisible||e.isActive||e.vpos>t+_||e.vpos<t-F)}activateComment(e,t,s,n,r,i){if(e.prepare(t,s,n,r),e.layout==="naka"){const c=Math.max(0,i-e.vpos),d=e.speedPixelsPerMs*c,f=e.virtualStartX-d;if(f<=-e.width){e.isActive=!1,e.hasShown=!0,e.clearActivation(),e.lane=-1;return}e.lane=this.findAvailableLane(e),e.y=e.lane*this.laneHeight,e.x=f,e.isActive=!0,e.hasShown=!0,e.isPaused=!this.isPlaying,e.markActivated(i),e.lastUpdateTime=this.timeSource.now();return}const a=e.vpos+y;if(i>a){e.isActive=!1,e.hasShown=!0,e.clearActivation(),e.lane=-1;return}const l=e.layout==="ue"?"ue":"shita",h=this.assignStaticLane(l);e.lane=h,e.y=h*this.laneHeight,e.x=e.virtualStartX,e.isActive=!0,e.hasShown=!0,e.isPaused=!this.isPlaying,e.markActivated(i),e.lastUpdateTime=this.timeSource.now(),e.staticExpiryTimeMs=a,this.reserveStaticLane(l,h,a)}assignStaticLane(e){const t=this.getStaticLaneMap(e),s=Array.from({length:this.laneCount},(i,a)=>a);e==="shita"&&s.reverse();for(const i of s)if(!t.has(i))return i;let n=s[0]??0,r=Number.POSITIVE_INFINITY;for(const[i,a]of t.entries())a<r&&(r=a,n=i);return n}reserveStaticLane(e,t,s){this.getStaticLaneMap(e).set(t,s)}releaseStaticLane(e,t){if(t<0)return;this.getStaticLaneMap(e).delete(t)}getLanePriorityOrder(e){const s=Array.from({length:this.laneCount},(a,l)=>l).sort((a,l)=>{const h=this.getLaneNextAvailableTime(a,e),c=this.getLaneNextAvailableTime(l,e);return Math.abs(h-c)<=m?a-l:h-c}),n=this.getStaticReservedLaneSet();if(n.size===0)return s;const r=s.filter(a=>!n.has(a));if(r.length===0)return s;const i=s.filter(a=>n.has(a));return[...r,...i]}getLaneNextAvailableTime(e,t){const s=this.reservedLanes.get(e);if(!s||s.length===0)return t;let n=t;for(const r of s)n=Math.max(n,r.endTime);return n}createLaneReservation(e,t){const s=Math.max(e.speedPixelsPerMs,m),n=t+e.preCollisionDurationMs+C,r=t+e.totalDurationMs+C;return{comment:e,startTime:t,endTime:Math.max(t,n),totalEndTime:Math.max(t,r),startLeft:e.virtualStartX,width:e.width,speed:s,buffer:e.bufferWidth}}isLaneAvailable(e,t,s){const n=this.reservedLanes.get(e);if(!n||n.length===0)return!0;for(const r of n)if(!(r.totalEndTime+C<=s)&&this.areReservationsConflicting(r,t))return!1;return!0}storeLaneReservation(e,t){const n=[...this.reservedLanes.get(e)??[],t].sort((r,i)=>r.endTime-i.endTime);this.reservedLanes.set(e,n)}areReservationsConflicting(e,t){const s=Math.max(e.startTime,t.startTime),n=Math.min(e.endTime,t.endTime);if(s>=n)return!1;const r=new Set([s,n,s+(n-s)/2]),i=this.solveLeftRightEqualityTime(e,t);i!==null&&i>=s-m&&i<=n+m&&r.add(i);const a=this.solveLeftRightEqualityTime(t,e);a!==null&&a>=s-m&&a<=n+m&&r.add(a);for(const l of r){if(l<s-m||l>n+m)continue;const h=this.computeForwardGap(e,t,l),c=this.computeForwardGap(t,e,l);if(h<=m&&c<=m)return!0}return!1}computeForwardGap(e,t,s){const n=this.getBufferedEdges(e,s),r=this.getBufferedEdges(t,s);return n.left-r.right}getBufferedEdges(e,t){const s=Math.max(0,t-e.startTime),n=e.speed*s,r=e.startLeft-n,i=r-e.buffer,a=r+e.width+e.buffer;return{left:i,right:a}}solveLeftRightEqualityTime(e,t){const s=t.speed-e.speed;if(Math.abs(s)<m)return null;const r=(t.startLeft+t.speed*t.startTime+t.width+t.buffer-e.startLeft-e.speed*e.startTime+e.buffer)/s;return Number.isFinite(r)?r:null}draw(){const e=this.canvas,t=this.ctx;if(!e||!t)return;t.clearRect(0,0,e.width,e.height);const s=this.comments.filter(r=>r.isActive),n=this.timeSource.now();if(this._settings.isCommentVisible){const r=(n-this.lastDrawTime)/16.666666666666668;s.forEach(i=>{const a=i.x-i.speed*r;i.draw(t,a)})}this.lastDrawTime=n}updateFrame=()=>{if(this.videoElement){if(!this._settings.isCommentVisible){this.frameId=this.animationFrameProvider.request(this.updateFrame);return}this.updateComments(),this.draw(),this.frameId=this.animationFrameProvider.request(this.updateFrame)}};startAnimation(){this.stopAnimation(),this.frameId=this.animationFrameProvider.request(this.updateFrame)}stopAnimation(){this.frameId!==null&&(this.animationFrameProvider.cancel(this.frameId),this.frameId=null)}onSeek(){const e=this.canvas,t=this.ctx,s=this.videoElement;if(!e||!t||!s)return;const n=g(s.currentTime);this.finalPhaseActive=!1,this.currentTime=n,this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear();const r=this.buildPrepareOptions(e.width);this.comments.forEach(i=>{if(this.isNGComment(i.text)){i.isActive=!1,i.clearActivation();return}if(i.isInvisible){i.isActive=!1,i.hasShown=!0,i.clearActivation();return}if(i.syncWithSettings(this._settings),i.isActive=!1,i.lane=-1,i.clearActivation(),this.shouldActivateCommentAtTime(i,this.currentTime)){this.activateComment(i,t,e.width,e.height,r,this.currentTime);return}i.vpos<this.currentTime-F?i.hasShown=!0:i.hasShown=!1})}setupVideoEventListeners(e){try{const t=()=>{this.isPlaying=!0;const c=this.timeSource.now();this.lastDrawTime=c,this.comments.forEach(d=>{d.lastUpdateTime=c,d.isPaused=!1})},s=()=>{this.isPlaying=!1;const c=this.timeSource.now();this.comments.forEach(d=>{d.lastUpdateTime=c,d.isPaused=!0})},n=()=>{this.onSeek()},r=()=>{this.onSeek()},i=()=>{this.playbackRate=e.playbackRate;const c=this.timeSource.now();this.comments.forEach(d=>{d.lastUpdateTime=c})},a=()=>{this.handleVideoMetadataLoaded(e)},l=()=>{this.duration=Number.isFinite(e.duration)?g(e.duration):0},h=()=>{this.handleVideoSourceChange()};e.addEventListener("play",t),e.addEventListener("pause",s),e.addEventListener("seeking",n),e.addEventListener("seeked",r),e.addEventListener("ratechange",i),e.addEventListener("loadedmetadata",a),e.addEventListener("durationchange",l),e.addEventListener("emptied",h),this.addCleanup(()=>e.removeEventListener("play",t)),this.addCleanup(()=>e.removeEventListener("pause",s)),this.addCleanup(()=>e.removeEventListener("seeking",n)),this.addCleanup(()=>e.removeEventListener("seeked",r)),this.addCleanup(()=>e.removeEventListener("ratechange",i)),this.addCleanup(()=>e.removeEventListener("loadedmetadata",a)),this.addCleanup(()=>e.removeEventListener("durationchange",l)),this.addCleanup(()=>e.removeEventListener("emptied",h))}catch(t){throw this.log.error("CommentRenderer.setupVideoEventListeners",t),t}}handleVideoMetadataLoaded(e){this.handleVideoSourceChange(e),this.resize(),this.calculateLaneMetrics(),this.onSeek()}handleVideoSourceChange(e){const t=e??this.videoElement;if(!t){this.isPlaying=!1,this.finalPhaseActive=!1,this.resetCommentActivity();return}this.syncVideoState(t),this.finalPhaseActive=!1,this.resetCommentActivity()}syncVideoState(e){this.duration=Number.isFinite(e.duration)?g(e.duration):0,this.currentTime=g(e.currentTime),this.playbackRate=e.playbackRate,this.isPlaying=!e.paused,this.lastDrawTime=this.timeSource.now()}resetCommentActivity(){const e=this.timeSource.now(),t=this.canvas,s=this.ctx;t&&s&&s.clearRect(0,0,t.width,t.height),this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear(),this.comments.forEach(n=>{n.isActive=!1,n.isPaused=!this.isPlaying,n.hasShown=!1,n.lane=-1,n.x=n.virtualStartX,n.speed=n.baseSpeed,n.lastUpdateTime=e,n.clearActivation()})}setupVideoChangeDetection(e,t){if(typeof MutationObserver>"u"){this.log.debug("MutationObserver is not available in this environment. Video change detection is disabled.");return}const s=new MutationObserver(r=>{for(const i of r){if(i.type==="attributes"&&i.attributeName==="src"){const a=i.target;let l=null,h=null;if((a instanceof HTMLVideoElement||a instanceof HTMLSourceElement)&&(l=typeof i.oldValue=="string"?i.oldValue:null,h=a.getAttribute("src")),l===h)continue;this.handleVideoSourceChange(e);return}if(i.type==="childList"){for(const a of i.addedNodes)if(a instanceof HTMLSourceElement){this.handleVideoSourceChange(e);return}for(const a of i.removedNodes)if(a instanceof HTMLSourceElement){this.handleVideoSourceChange(e);return}}}});s.observe(e,{attributes:!0,attributeFilter:["src"],attributeOldValue:!0,childList:!0,subtree:!0}),this.addCleanup(()=>s.disconnect());const n=new MutationObserver(r=>{for(const i of r)if(i.type==="childList"){for(const a of i.addedNodes){const l=this.extractVideoElement(a);if(l&&l!==this.videoElement){this.initialize(l);return}}for(const a of i.removedNodes){if(a===this.videoElement){this.videoElement=null,this.handleVideoSourceChange(null);return}if(a instanceof Element){const l=a.querySelector("video");if(l&&l===this.videoElement){this.videoElement=null,this.handleVideoSourceChange(null);return}}}}});n.observe(t,{childList:!0,subtree:!0}),this.addCleanup(()=>n.disconnect())}extractVideoElement(e){if(e instanceof HTMLVideoElement)return e;if(e instanceof Element){const t=e.querySelector("video");if(t instanceof HTMLVideoElement)return t}return null}setupResizeHandling(e){if(this.cleanupResizeHandling(),this._settings.useContainerResizeObserver&&this.isResizeObserverAvailable){const t=e.parentElement??e,s=new ResizeObserver(n=>{for(const r of n){const{width:i,height:a}=r.contentRect;i>0&&a>0?this.resize(i,a):this.resize()}});s.observe(t),this.resizeObserver=s,this.resizeObserverTarget=t}else if(typeof window<"u"&&typeof window.addEventListener=="function"){const t=()=>{this.resize()};window.addEventListener("resize",t),this.addCleanup(()=>window.removeEventListener("resize",t))}else this.log.debug("Resize handling is disabled because neither ResizeObserver nor window APIs are available.")}cleanupResizeHandling(){this.resizeObserver&&this.resizeObserverTarget&&this.resizeObserver.unobserve(this.resizeObserverTarget),this.resizeObserver?.disconnect(),this.resizeObserver=null,this.resizeObserverTarget=null}addCleanup(e){this.cleanupTasks.push(e)}runCleanupTasks(){for(;this.cleanupTasks.length>0;){const e=this.cleanupTasks.pop();try{e?.()}catch(t){this.log.error("CommentRenderer.cleanupTask",t)}}}}exports.COMMENT_OVERLAY_VERSION=oe;exports.Comment=I;exports.CommentRenderer=ye;exports.DEFAULT_RENDERER_SETTINGS=ae;exports.cloneDefaultSettings=z;exports.createDefaultAnimationFrameProvider=D;exports.createDefaultTimeSource=R;exports.createLogger=L;
//# sourceMappingURL=comment-overlay.cjs.map
