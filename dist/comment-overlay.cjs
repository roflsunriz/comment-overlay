"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const ae={debug:0,info:1,warn:2,error:3},be=(o,e,t)=>{const i=[`[${e}]`,...t];switch(o){case"debug":console.debug(...i);break;case"info":console.info(...i);break;case"warn":console.warn(...i);break;case"error":console.error(...i);break;default:console.log(...i)}},te=(o,e={})=>{const{level:t="info",emitter:s=be}=e,i=ae[t],n=(a,r)=>{ae[a]<i||s(a,o,r)};return{debug:(...a)=>n("debug",a),info:(...a)=>n("info",a),warn:(...a)=>n("warn",a),error:(...a)=>n("error",a)}},Me={small:.8,medium:1,big:1.4},ye={defont:'"MS PGothic","Hiragino Kaku Gothic ProN","Hiragino Kaku Gothic Pro","Yu Gothic UI","Yu Gothic","Meiryo","Segoe UI","Osaka","Noto Sans CJK JP","Noto Sans JP","Source Han Sans JP","IPAPGothic","TakaoPGothic","Roboto","Helvetica Neue","Helvetica","Arial","sans-serif"',gothic:'"Noto Sans CJK JP","Noto Sans JP","Source Han Sans JP","Yu Gothic","Yu Gothic Medium","Meiryo","MS PGothic","Hiragino Kaku Gothic ProN","Segoe UI","Helvetica","Arial","sans-serif"',mincho:'"MS PMincho","MS Mincho","Hiragino Mincho ProN","Hiragino Mincho Pro","Yu Mincho","Noto Serif CJK JP","Noto Serif JP","Source Han Serif JP","Times New Roman","serif"'},de={white:"#FFFFFF",red:"#FF0000",pink:"#FF8080",orange:"#FF9900",yellow:"#FFFF00",green:"#00FF00",cyan:"#00FFFF",blue:"#0000FF",purple:"#C000FF",black:"#000000",white2:"#CC9",red2:"#C03",pink2:"#F3C",orange2:"#F60",yellow2:"#990",green2:"#0C6",cyan2:"#0CC",blue2:"#39F",purple2:"#63C",black2:"#666"},ie=/^#([0-9a-f]{3}|[0-9a-f]{4}|[0-9a-f]{6}|[0-9a-f]{8})$/i,Ce=/^[,.:;]+/,we=/[,.:;]+$/,xe=o=>{const e=o.trim();return e?ie.test(e)?e:e.replace(Ce,"").replace(we,""):""},Te=o=>ie.test(o)?o.toUpperCase():null,fe=o=>{const e=o.trim();if(!e)return null;const t=e.toLowerCase().endsWith("px")?e.slice(0,-2):e,s=Number.parseFloat(t);return Number.isFinite(s)?s:null},Ee=o=>{const e=o.trim();if(!e)return null;if(e.endsWith("%")){const t=Number.parseFloat(e.slice(0,-1));return Number.isFinite(t)?t/100:null}return fe(e)},Fe=o=>Number.isFinite(o)?Math.min(100,Math.max(-100,o)):0,Le=o=>!Number.isFinite(o)||o===0?1:Math.min(5,Math.max(.25,o)),Pe=o=>o==="naka"||o==="ue"||o==="shita",Ae=o=>o==="small"||o==="medium"||o==="big",De=o=>o==="defont"||o==="gothic"||o==="mincho",Re=o=>o in de,ke=(o,e)=>{let t="naka",s="medium",i="defont",n=null,a=1,r=null,h=!1,u=0,l=1;for(const p of o){const m=xe(typeof p=="string"?p:"");if(!m)continue;if(ie.test(m)){const y=Te(m);if(y){n=y;continue}}const v=m.toLowerCase();if(Pe(v)){t=v;continue}if(Ae(v)){s=v;continue}if(De(v)){i=v;continue}if(Re(v)){n=de[v].toUpperCase();continue}if(v==="_live"){r=.5;continue}if(v==="invisible"){a=0,h=!0;continue}if(v.startsWith("ls:")||v.startsWith("letterspacing:")){const y=m.indexOf(":");if(y>=0){const M=fe(m.slice(y+1));M!==null&&(u=Fe(M))}continue}if(v.startsWith("lh:")||v.startsWith("lineheight:")){const y=m.indexOf(":");if(y>=0){const M=Ee(m.slice(y+1));M!==null&&(l=Le(M))}continue}}const f=Math.max(0,Math.min(1,a)),c=(n??e.defaultColor).toUpperCase(),g=typeof r=="number"?Math.max(0,Math.min(1,r)):null;return{layout:t,size:s,sizeScale:Me[s],font:i,fontFamily:ye[i],resolvedColor:c,colorOverride:n,opacityMultiplier:f,opacityOverride:g,isInvisible:h,letterSpacing:u,lineHeight:l}},Q=5,H={enabled:!1,maxLogsPerCategory:Q},B=new Map,Oe=o=>{if(o===void 0||!Number.isFinite(o))return Q;const e=Math.max(1,Math.floor(o));return Math.min(1e4,e)},pe=o=>{H.enabled=!!o.enabled,H.maxLogsPerCategory=Oe(o.maxLogsPerCategory),H.enabled||B.clear()},Ve=()=>{B.clear()},E=()=>H.enabled,Ne=o=>{const e=B.get(o)??0;return e>=H.maxLogsPerCategory?(e===H.maxLogsPerCategory&&(console.debug(`[CommentOverlay][${o}]`,"Further logs suppressed."),B.set(o,e+1)),!1):(B.set(o,e+1),!0)},w=(o,...e)=>{H.enabled&&Ne(o)&&console.debug(`[CommentOverlay][${o}]`,...e)},P=(o,e=32)=>o.length<=e?o:`${o.slice(0,e)}…`,J=te("CommentEngine:Comment"),re=new WeakMap,Ie=o=>{let e=re.get(o);return e||(e=new Map,re.set(o,e)),e},_=(o,e)=>{if(!o)return 0;const s=`${o.font??""}::${e}`,i=Ie(o),n=i.get(s);if(n!==void 0)return n;const a=o.measureText(e).width;return i.set(s,a),a},I=4e3,He=/^#([0-9A-F]{3}|[0-9A-F]{4}|[0-9A-F]{6}|[0-9A-F]{8})$/i,R=o=>!Number.isFinite(o)||o<=0?0:o>=1?1:o,G=o=>o.length===1?o.repeat(2):o,A=o=>Number.parseInt(o,16),oe=(o,e)=>{const t=He.exec(o);if(!t)return o;const s=t[1];let i,n,a,r=1;s.length===3||s.length===4?(i=A(G(s[0])),n=A(G(s[1])),a=A(G(s[2])),s.length===4&&(r=A(G(s[3]))/255)):(i=A(s.slice(0,2)),n=A(s.slice(2,4)),a=A(s.slice(4,6)),s.length===8&&(r=A(s.slice(6,8))/255));const h=R(r*R(e));return`rgba(${i}, ${n}, ${a}, ${h})`},ze=()=>({now:()=>typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}),se=()=>ze(),We=o=>o==="ltr"?"ltr":"rtl",_e=o=>o==="ltr"?1:-1;class d{text;vposMs;commands;layout;isScrolling;sizeScale;opacityMultiplier;opacityOverride;colorOverride;isInvisible;x=0;y=0;width=0;height=0;baseSpeed=0;speed=0;lane=-1;color;fontSize=0;fontFamily;opacity;activationTimeMs=null;staticExpiryTimeMs=null;isActive=!1;hasShown=!1;isPaused=!1;lastUpdateTime=0;reservationWidth=0;bufferWidth=0;visibleDurationMs=0;totalDurationMs=0;preCollisionDurationMs=0;speedPixelsPerMs=0;virtualStartX=0;exitThreshold=0;scrollDirection="rtl";renderStyle="outline-only";creationIndex=0;letterSpacing=0;lineHeightMultiplier=1;lineHeightPx=0;lines=[];strokeTextThreshold=30;directionSign=-1;timeSource;lastSyncedSettingsVersion=-1;cachedTexture=null;textureCacheKey="";constructor(e,t,s,i,n={}){if(typeof e!="string")throw new Error("Comment text must be a string");if(!Number.isFinite(t)||t<0)throw new Error("Comment vposMs must be a non-negative number");this.text=e,this.vposMs=t,this.commands=Array.isArray(s)?[...s]:[];const a=ke(this.commands,{defaultColor:i.commentColor});this.layout=a.layout,this.isScrolling=this.layout==="naka",this.sizeScale=a.sizeScale,this.opacityMultiplier=a.opacityMultiplier,this.opacityOverride=a.opacityOverride,this.colorOverride=a.colorOverride,this.isInvisible=a.isInvisible,this.fontFamily=a.fontFamily,this.color=a.resolvedColor,this.opacity=this.getEffectiveOpacity(i.commentOpacity),this.renderStyle=i.renderStyle,this.letterSpacing=a.letterSpacing,this.lineHeightMultiplier=a.lineHeight,this.timeSource=n.timeSource??se(),this.applyScrollDirection(i.scrollDirection),this.syncWithSettings(i,n.settingsVersion)}prepare(e,t,s,i){try{if(!e)throw new Error("Canvas context is required");if(!Number.isFinite(t)||!Number.isFinite(s))throw new Error("Canvas dimensions must be numbers");if(!i)throw new Error("Prepare options are required");const n=Math.max(t,1),a=Math.max(24,Math.floor(s*.05)),r=Math.max(24,Math.floor(a*this.sizeScale));this.fontSize=r,e.font=`${this.fontSize}px ${this.fontFamily}`;const h=this.text.includes(`
`)?this.text.split(/\r?\n/):[this.text];this.lines=h.length>0?h:[""];let u=0;const l=this.letterSpacing;for(const L of this.lines){const K=_(e,L),Se=L.length>1?l*(L.length-1):0,ne=Math.max(0,K+Se);ne>u&&(u=ne)}this.width=u;const f=Math.max(1,Math.floor(this.fontSize*this.lineHeightMultiplier));if(this.lineHeightPx=f,this.height=this.fontSize+(this.lines.length>1?(this.lines.length-1)*f:0),!this.isScrolling){this.bufferWidth=0;const L=Math.max((n-this.width)/2,0);this.virtualStartX=L,this.x=L,this.baseSpeed=0,this.speed=0,this.speedPixelsPerMs=0,this.visibleDurationMs=I,this.preCollisionDurationMs=I,this.totalDurationMs=I,this.reservationWidth=this.width,this.staticExpiryTimeMs=this.vposMs+I,this.lastUpdateTime=this.timeSource.now(),this.isPaused=!1;return}this.staticExpiryTimeMs=null;const c=_(e,"??".repeat(150)),g=this.width*Math.max(i.bufferRatio,0);this.bufferWidth=Math.max(i.baseBufferPx,g);const p=Math.max(i.entryBufferPx,this.bufferWidth),m=this.scrollDirection,v=m==="rtl"?n+i.virtualExtension:-this.width-this.bufferWidth-i.virtualExtension,y=m==="rtl"?-this.width-this.bufferWidth-p:n+p,M=m==="rtl"?n+p:-p,x=m==="rtl"?v+this.width+this.bufferWidth:v-this.bufferWidth;this.virtualStartX=v,this.x=v,this.exitThreshold=y;const b=n>0?this.width/n:0,C=i.maxVisibleDurationMs===i.minVisibleDurationMs;let S=i.maxVisibleDurationMs;if(!C&&b>1){const L=Math.min(b,i.maxWidthRatio),K=i.maxVisibleDurationMs/Math.max(L,1);S=Math.max(i.minVisibleDurationMs,Math.floor(K))}const k=n+this.width+this.bufferWidth+p,O=Math.max(S,1),F=k/O,z=F*1e3/60;this.baseSpeed=z,this.speed=this.baseSpeed,this.speedPixelsPerMs=F;const W=Math.abs(y-v),X=m==="rtl"?Math.max(0,x-M):Math.max(0,M-x),U=Math.max(F,Number.EPSILON);this.visibleDurationMs=S,this.preCollisionDurationMs=Math.max(0,Math.ceil(X/U)),this.totalDurationMs=Math.max(this.preCollisionDurationMs,Math.ceil(W/U));const me=this.width+this.bufferWidth+p;this.reservationWidth=Math.min(c,me),this.lastUpdateTime=this.timeSource.now(),this.isPaused=!1}catch(n){throw J.error("Comment.prepare",n,{text:this.text,visibleWidth:t,canvasHeight:s,hasContext:!!e}),n}}update(e=1,t=!1){try{if(!this.isActive){this.isPaused=t;return}const s=this.timeSource.now();if(!this.isScrolling){this.isPaused=t,this.lastUpdateTime=s;return}if(t){this.isPaused=!0,this.lastUpdateTime=s;return}const i=(s-this.lastUpdateTime)/(1e3/60);this.speed=this.baseSpeed*e,this.x+=this.speed*i*this.directionSign,(this.scrollDirection==="rtl"&&this.x<=this.exitThreshold||this.scrollDirection==="ltr"&&this.x>=this.exitThreshold)&&(this.isActive=!1),this.lastUpdateTime=s,this.isPaused=!1}catch(s){J.error("Comment.update",s,{text:this.text,playbackRate:e,isPaused:t,isActive:this.isActive})}}generateTextureCacheKey(){return`v2::${this.text}::${this.fontSize}::${this.fontFamily}::${this.color}::${this.opacity}::${this.renderStyle}::${this.letterSpacing}::${this.lines.length}`}static cacheStats={hits:0,misses:0,creates:0,fallbacks:0,strokeCallsInCache:0,fillCallsInCache:0,strokeCallsInFallback:0,fillCallsInFallback:0,letterSpacingComments:0,normalComments:0,multiLineComments:0,totalCharactersDrawn:0,strokeSkippedCount:0,strokeUsedCount:0,smallFontComments:0,largeFontComments:0,lastReported:0};static reportCacheStats(){if(!E())return;const e=performance.now();if(e-d.cacheStats.lastReported>5e3){const t=d.cacheStats.hits+d.cacheStats.misses,s=t>0?d.cacheStats.hits/t*100:0,i=d.cacheStats.creates>0?(d.cacheStats.totalCharactersDrawn/d.cacheStats.creates).toFixed(1):"0",n=d.cacheStats.strokeUsedCount+d.cacheStats.strokeSkippedCount>0?(d.cacheStats.strokeSkippedCount/(d.cacheStats.strokeUsedCount+d.cacheStats.strokeSkippedCount)*100).toFixed(1):"0";console.log("[TextureCache Stats]",`
  Cache: Hits=${d.cacheStats.hits}, Misses=${d.cacheStats.misses}, Hit Rate=${s.toFixed(1)}%`,`
  Creates: ${d.cacheStats.creates}, Fallbacks: ${d.cacheStats.fallbacks}`,`
  Comments: Normal=${d.cacheStats.normalComments}, LetterSpacing=${d.cacheStats.letterSpacingComments}, MultiLine=${d.cacheStats.multiLineComments}`,`
  Font Sizes: Small(<30px)=${d.cacheStats.smallFontComments}, Large(≥30px)=${d.cacheStats.largeFontComments}`,`
  Stroke: Used=${d.cacheStats.strokeUsedCount}, Skipped=${d.cacheStats.strokeSkippedCount}, Reduction=${n}%`,`
  Draw Calls: StrokeText=${d.cacheStats.strokeCallsInCache+d.cacheStats.strokeCallsInFallback}, FillText=${d.cacheStats.fillCallsInCache+d.cacheStats.fillCallsInFallback}`,`
  Avg Characters/Comment: ${i}`),d.cacheStats.lastReported=e}}isOffscreenCanvasSupported(){return typeof OffscreenCanvas<"u"}createTextureCanvas(e){if(!this.isOffscreenCanvasSupported())return null;const t=Math.abs(this.letterSpacing)>=Number.EPSILON,s=this.lines.length>1;t&&d.cacheStats.letterSpacingComments++,s&&d.cacheStats.multiLineComments++,!t&&!s&&d.cacheStats.normalComments++,d.cacheStats.totalCharactersDrawn+=this.text.length,this.fontSize<this.strokeTextThreshold?d.cacheStats.smallFontComments++:d.cacheStats.largeFontComments++;const i=Math.max(10,this.fontSize*.5),n=Math.ceil(this.width+i*2),a=Math.ceil(this.height+i*2),r=new OffscreenCanvas(n,a),h=r.getContext("2d");if(!h)return null;h.save(),h.font=`${this.fontSize}px ${this.fontFamily}`;const u=R(this.opacity),l=i,f=this.lines.length>0?this.lines:[this.text],c=this.lines.length>1&&this.lineHeightPx>0?this.lineHeightPx:this.fontSize,g=i+this.fontSize,p=(M,x,b)=>{if(M.length===0)return;const C=M.match(/^[\u3000\u00A0]+/),S=C?C[0].length:0,k=S>0?_(e,C[0]):0,O=l+k,F=S>0?M.substring(S):M;if(Math.abs(this.letterSpacing)<Number.EPSILON){b==="stroke"?(d.cacheStats.strokeCallsInCache++,h.strokeText(F,O,x)):(d.cacheStats.fillCallsInCache++,h.fillText(F,O,x));return}let z=O;for(let W=0;W<F.length;W+=1){const X=F[W];b==="stroke"?(d.cacheStats.strokeCallsInCache++,h.strokeText(X,z,x)):(d.cacheStats.fillCallsInCache++,h.fillText(X,z,x));const U=_(e,X);z+=U,W<F.length-1&&(z+=this.letterSpacing)}},m=this.fontSize>=this.strokeTextThreshold,v=()=>{if(!m){d.cacheStats.strokeSkippedCount++;return}d.cacheStats.strokeUsedCount++,h.globalAlpha=u,h.strokeStyle="#000000",h.lineWidth=Math.max(3,this.fontSize/8),h.lineJoin="round",f.forEach((M,x)=>{const b=g+x*c;p(M,b,"stroke")}),h.globalAlpha=1},y=()=>{m||(h.shadowColor="#000000",h.shadowBlur=Math.max(2,this.fontSize*.1),h.shadowOffsetX=0,h.shadowOffsetY=0),f.forEach((M,x)=>{const b=g+x*c;p(M,b,"fill")}),m||(h.shadowColor="transparent",h.shadowBlur=0)};if(v(),this.renderStyle==="classic"){const M=Math.max(1,this.fontSize*.04),x=this.fontSize*.18;[{offsetXMultiplier:.9,offsetYMultiplier:1.1,blurMultiplier:.55,alpha:.52,rgb:"20, 28, 40"},{offsetXMultiplier:2.4,offsetYMultiplier:2.7,blurMultiplier:1.45,alpha:.32,rgb:"0, 0, 0"},{offsetXMultiplier:-.7,offsetYMultiplier:-.6,blurMultiplier:.4,alpha:.42,rgb:"255, 255, 255"}].forEach(C=>{const S=R(C.alpha*u);h.shadowColor=`rgba(${C.rgb}, ${S})`,h.shadowBlur=x*C.blurMultiplier,h.shadowOffsetX=M*C.offsetXMultiplier,h.shadowOffsetY=M*C.offsetYMultiplier,h.fillStyle="rgba(0, 0, 0, 0)",y()}),h.shadowColor="transparent",h.shadowBlur=0,h.shadowOffsetX=0,h.shadowOffsetY=0}else h.shadowColor="transparent",h.shadowBlur=0,h.shadowOffsetX=0,h.shadowOffsetY=0;return h.globalAlpha=1,h.fillStyle=oe(this.color,u),y(),h.restore(),r}draw(e,t=null){try{if(!this.isActive||!e)return;const s=this.generateTextureCacheKey();if(this.textureCacheKey!==s||!this.cachedTexture?(d.cacheStats.misses++,d.cacheStats.creates++,this.cachedTexture=this.createTextureCanvas(e),this.textureCacheKey=s):d.cacheStats.hits++,this.cachedTexture){const g=t??this.x,p=Math.max(10,this.fontSize*.5);e.drawImage(this.cachedTexture,g-p,this.y-p),d.reportCacheStats();return}d.cacheStats.fallbacks++,e.save(),e.font=`${this.fontSize}px ${this.fontFamily}`;const i=R(this.opacity),n=t??this.x,a=this.lines.length>0?this.lines:[this.text],r=this.lines.length>1&&this.lineHeightPx>0?this.lineHeightPx:this.fontSize,h=this.y+this.fontSize,u=(g,p,m)=>{if(g.length===0)return;const v=g.match(/^[\u3000\u00A0]+/),y=v?v[0].length:0,M=y>0?_(e,v[0]):0,x=n+M,b=y>0?g.substring(y):g;if(Math.abs(this.letterSpacing)<Number.EPSILON){m==="stroke"?(d.cacheStats.strokeCallsInFallback++,e.strokeText(b,x,p)):(d.cacheStats.fillCallsInFallback++,e.fillText(b,x,p));return}let C=x;for(let S=0;S<b.length;S+=1){const k=b[S];m==="stroke"?(d.cacheStats.strokeCallsInFallback++,e.strokeText(k,C,p)):(d.cacheStats.fillCallsInFallback++,e.fillText(k,C,p));const O=_(e,k);C+=O,S<b.length-1&&(C+=this.letterSpacing)}},l=this.fontSize>=this.strokeTextThreshold,f=()=>{if(!l){d.cacheStats.strokeSkippedCount++;return}d.cacheStats.strokeUsedCount++,e.globalAlpha=i,e.strokeStyle="#000000",e.lineWidth=Math.max(3,this.fontSize/8),e.lineJoin="round",a.forEach((g,p)=>{const m=h+p*r;u(g,m,"stroke")}),e.globalAlpha=1},c=()=>{l||(e.shadowColor="#000000",e.shadowBlur=Math.max(2,this.fontSize*.1),e.shadowOffsetX=0,e.shadowOffsetY=0),a.forEach((g,p)=>{const m=h+p*r;u(g,m,"fill")}),l||(e.shadowColor="transparent",e.shadowBlur=0)};if(f(),this.renderStyle==="classic"){const g=Math.max(1,this.fontSize*.04),p=this.fontSize*.18;[{offsetXMultiplier:.9,offsetYMultiplier:1.1,blurMultiplier:.55,alpha:.52,rgb:"20, 28, 40"},{offsetXMultiplier:2.4,offsetYMultiplier:2.7,blurMultiplier:1.45,alpha:.32,rgb:"0, 0, 0"},{offsetXMultiplier:-.7,offsetYMultiplier:-.6,blurMultiplier:.4,alpha:.42,rgb:"255, 255, 255"}].forEach(v=>{const y=R(v.alpha*i);e.shadowColor=`rgba(${v.rgb}, ${y})`,e.shadowBlur=p*v.blurMultiplier,e.shadowOffsetX=g*v.offsetXMultiplier,e.shadowOffsetY=g*v.offsetYMultiplier,e.fillStyle="rgba(0, 0, 0, 0)",c()}),e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0}else e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0;e.globalAlpha=1,e.fillStyle=oe(this.color,i),c(),e.restore(),d.reportCacheStats()}catch(s){J.error("Comment.draw",s,{text:this.text,isActive:this.isActive,hasContext:!!e,interpolatedX:t})}}syncWithSettings(e,t){typeof t=="number"&&t===this.lastSyncedSettingsVersion||(this.color=this.getEffectiveColor(e.commentColor),this.opacity=this.getEffectiveOpacity(e.commentOpacity),this.applyScrollDirection(e.scrollDirection),this.renderStyle=e.renderStyle,this.strokeTextThreshold=e.strokeTextThreshold,typeof t=="number"&&(this.lastSyncedSettingsVersion=t))}getEffectiveColor(e){const t=this.colorOverride??e;return typeof t!="string"||t.length===0?e:t.toUpperCase()}getEffectiveOpacity(e){if(typeof this.opacityOverride=="number")return R(this.opacityOverride);const t=e*this.opacityMultiplier;return Number.isFinite(t)?R(t):0}markActivated(e){this.activationTimeMs=e}clearActivation(){this.activationTimeMs=null,this.isScrolling||(this.staticExpiryTimeMs=null),this.cachedTexture=null,this.textureCacheKey=""}hasStaticExpired(e){return this.isScrolling||this.staticExpiryTimeMs===null?!1:e>=this.staticExpiryTimeMs}getDirectionSign(){return this.directionSign}applyScrollDirection(e){const t=We(e);this.scrollDirection=t,this.directionSign=_e(t)}}const Xe=4e3,Y={commentColor:"#FFFFFF",commentOpacity:1,isCommentVisible:!0,useContainerResizeObserver:!0,ngWords:[],ngRegexps:[],scrollDirection:"rtl",renderStyle:"outline-only",syncMode:"raf",scrollVisibleDurationMs:Xe,useFixedLaneCount:!1,fixedLaneCount:12,useDprScaling:!0,strokeTextThreshold:30},$e=Y,ve=()=>({...Y,ngWords:[...Y.ngWords],ngRegexps:[...Y.ngRegexps]}),Be="v2.2.0",D=o=>o*1e3,Ue=o=>!Number.isFinite(o)||o<0?null:Math.round(o),ee=4e3,le=1800,Ge=3,qe=.25,Ye=32,Ke=48,j=120,Je=4e3,Z=120,je=800,Ze=2,$=4e3,V=I+ee,Qe=1e3,he=1,ce=12,ue=24,T=.001,N=50,et=o=>Number.isFinite(o)?o<=0?0:o>=1?1:o:1,q=o=>{const e=o.scrollVisibleDurationMs,t=e==null?null:Number.isFinite(e)?Math.max(1,Math.floor(e)):null;return{...o,scrollDirection:o.scrollDirection==="ltr"?"ltr":"rtl",commentOpacity:et(o.commentOpacity),renderStyle:o.renderStyle==="classic"?"classic":"outline-only",scrollVisibleDurationMs:t,syncMode:o.syncMode==="video-frame"?"video-frame":"raf",useDprScaling:!!o.useDprScaling}},ge=o=>typeof window<"u"&&typeof window.requestAnimationFrame=="function"&&typeof window.cancelAnimationFrame=="function"?{request:e=>window.requestAnimationFrame(e),cancel:e=>window.cancelAnimationFrame(e)}:{request:e=>globalThis.setTimeout(()=>{e(o.now())},16),cancel:e=>{globalThis.clearTimeout(e)}},tt=()=>typeof document>"u"?()=>{throw new Error("Document is not available. Provide a custom createCanvasElement implementation.")}:()=>document.createElement("canvas"),it=o=>{if(!o||typeof o!="object")return!1;const e=o;return typeof e.commentColor=="string"&&typeof e.commentOpacity=="number"&&typeof e.isCommentVisible=="boolean"};class st{_settings;comments=[];activeComments=new Set;reservedLanes=new Map;topStaticLaneReservations=new Map;bottomStaticLaneReservations=new Map;log;timeSource;animationFrameProvider;createCanvasElement;commentDependencies;settingsVersion=0;normalizedNgWords=[];compiledNgRegexps=[];canvas=null;ctx=null;videoElement=null;containerElement=null;fullscreenActive=!1;laneCount=ce;laneHeight=0;displayWidth=0;displayHeight=0;canvasDpr=1;currentTime=0;duration=0;playbackRate=1;isPlaying=!0;lastDrawTime=0;finalPhaseActive=!1;finalPhaseStartTime=null;finalPhaseScheduleDirty=!1;playbackHasBegun=!1;skipDrawingForCurrentFrame=!1;finalPhaseVposOverrides=new Map;frameId=null;videoFrameHandle=null;resizeObserver=null;resizeObserverTarget=null;isResizeObserverAvailable=typeof ResizeObserver<"u";cleanupTasks=[];commentSequence=0;constructor(e=null,t=void 0){let s,i;if(it(e))s=q({...e}),i=t??{};else{const n=e??t??{};i=typeof n=="object"?n:{},s=q(ve())}this.timeSource=i.timeSource??se(),this.animationFrameProvider=i.animationFrameProvider??ge(this.timeSource),this.createCanvasElement=i.createCanvasElement??tt(),this.commentDependencies={timeSource:this.timeSource,settingsVersion:this.settingsVersion},this._settings=q(s),this.log=te(i.loggerNamespace??"CommentRenderer"),this.rebuildNgMatchers(),i.debug&&pe(i.debug)}get settings(){return this._settings}set settings(e){this._settings=q(e),this.settingsVersion+=1,this.commentDependencies.settingsVersion=this.settingsVersion,this.rebuildNgMatchers()}resolveContainer(e,t){if(e)return e;if(t.parentElement)return t.parentElement;if(typeof document<"u"&&document.body)return document.body;throw new Error("Cannot resolve container element. Provide container explicitly when DOM is unavailable.")}ensureContainerPositioning(e){if(typeof getComputedStyle=="function"){getComputedStyle(e).position==="static"&&(e.style.position="relative");return}e.style.position||(e.style.position="relative")}initialize(e){try{this.destroyCanvasOnly();const t=e instanceof HTMLVideoElement?e:e.video,s=e instanceof HTMLVideoElement?e.parentElement:e.container??e.video.parentElement,i=this.resolveContainer(s??null,t);this.videoElement=t,this.containerElement=i,this.duration=Number.isFinite(t.duration)?D(t.duration):0,this.currentTime=D(t.currentTime),this.playbackRate=t.playbackRate,this.isPlaying=!t.paused,this.lastDrawTime=this.timeSource.now(),this.playbackHasBegun=this.isPlaying||this.currentTime>N,this.skipDrawingForCurrentFrame=this.shouldSuppressRendering();const n=this.createCanvasElement(),a=n.getContext("2d");if(!a)throw new Error("Failed to acquire 2D canvas context");n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.pointerEvents="none",n.style.zIndex="1000";const r=this.containerElement;r instanceof HTMLElement&&(this.ensureContainerPositioning(r),r.appendChild(n)),this.canvas=n,this.ctx=a,this.resize(),this.calculateLaneMetrics(),this.setupVideoEventListeners(t),this.setupResizeHandling(t),this.setupFullscreenHandling(),this.setupVideoChangeDetection(t,i),this.startAnimation(),this.setupVisibilityHandling()}catch(t){throw this.log.error("CommentRenderer.initialize",t),t}}addComments(e){if(!Array.isArray(e)||e.length===0)return[];const t=[];this.commentDependencies.settingsVersion=this.settingsVersion;for(const s of e){const{text:i,vposMs:n,commands:a=[]}=s,r=P(i);if(this.isNGComment(i)){w("comment-skip-ng",{preview:r,vposMs:n});continue}const h=Ue(n);if(h===null){this.log.warn("CommentRenderer.addComment.invalidVpos",{text:i,vposMs:n}),w("comment-skip-invalid-vpos",{preview:r,vposMs:n});continue}if(this.comments.some(f=>f.text===i&&f.vposMs===h)||t.some(f=>f.text===i&&f.vposMs===h)){w("comment-skip-duplicate",{preview:r,vposMs:h});continue}const l=new d(i,h,a,this._settings,this.commentDependencies);l.creationIndex=this.commentSequence++,t.push(l),w("comment-added",{preview:r,vposMs:h,commands:l.commands.length,layout:l.layout,isScrolling:l.isScrolling,invisible:l.isInvisible})}return t.length===0?[]:(this.comments.push(...t),this.finalPhaseActive&&(this.finalPhaseScheduleDirty=!0),this.comments.sort((s,i)=>{const n=s.vposMs-i.vposMs;return Math.abs(n)>T?n:s.creationIndex-i.creationIndex}),t)}addComment(e,t,s=[]){const[i]=this.addComments([{text:e,vposMs:t,commands:s}]);return i??null}clearComments(){if(this.comments.length=0,this.activeComments.clear(),this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear(),this.commentSequence=0,this.ctx&&this.canvas){const e=this.canvasDpr>0?this.canvasDpr:1,t=this.displayWidth>0?this.displayWidth:this.canvas.width/e,s=this.displayHeight>0?this.displayHeight:this.canvas.height/e;this.ctx.clearRect(0,0,t,s)}}resetState(){this.clearComments(),this.currentTime=0,this.resetFinalPhaseState(),this.playbackHasBegun=!1,this.skipDrawingForCurrentFrame=!1}destroy(){this.stopAnimation(),this.cleanupResizeHandling(),this.runCleanupTasks(),this.canvas&&this.canvas.remove(),this.canvas=null,this.ctx=null,this.videoElement=null,this.containerElement=null,this.comments.length=0,this.activeComments.clear(),this.reservedLanes.clear(),this.resetFinalPhaseState(),this.displayWidth=0,this.displayHeight=0,this.canvasDpr=1,this.commentSequence=0,this.playbackHasBegun=!1,this.skipDrawingForCurrentFrame=!1}resetFinalPhaseState(){this.finalPhaseActive=!1,this.finalPhaseStartTime=null,this.finalPhaseScheduleDirty=!1,this.finalPhaseVposOverrides.clear()}getEffectiveCommentVpos(e){return this.finalPhaseActive&&this.finalPhaseScheduleDirty&&this.recomputeFinalPhaseTimeline(),this.finalPhaseVposOverrides.get(e)??e.vposMs}getFinalPhaseDisplayDuration(e){if(!e.isScrolling)return I;const t=[];return Number.isFinite(e.visibleDurationMs)&&e.visibleDurationMs>0&&t.push(e.visibleDurationMs),Number.isFinite(e.totalDurationMs)&&e.totalDurationMs>0&&t.push(e.totalDurationMs),t.length>0?Math.max(...t):ee}resolveFinalPhaseVpos(e){if(!this.finalPhaseActive||this.finalPhaseStartTime===null)return this.finalPhaseVposOverrides.delete(e),e.vposMs;this.finalPhaseScheduleDirty&&this.recomputeFinalPhaseTimeline();const t=this.finalPhaseVposOverrides.get(e);if(t!==void 0)return t;const s=Math.max(e.vposMs,this.finalPhaseStartTime);return this.finalPhaseVposOverrides.set(e,s),s}recomputeFinalPhaseTimeline(){if(!this.finalPhaseActive||this.finalPhaseStartTime===null){this.finalPhaseVposOverrides.clear(),this.finalPhaseScheduleDirty=!1;return}const e=this.finalPhaseStartTime,t=this.duration>0?this.duration:e+$,s=Math.max(e+$,t),i=this.comments.filter(l=>l.hasShown||l.isInvisible||this.isNGComment(l.text)?!1:l.vposMs>=e-V).sort((l,f)=>{const c=l.vposMs-f.vposMs;return Math.abs(c)>T?c:l.creationIndex-f.creationIndex});if(this.finalPhaseVposOverrides.clear(),i.length===0){this.finalPhaseScheduleDirty=!1;return}const a=Math.max(s-e,$)/Math.max(i.length,1),r=Number.isFinite(a)?a:Z,h=Math.max(Z,Math.min(r,je));let u=e;i.forEach((l,f)=>{const c=Math.max(1,this.getFinalPhaseDisplayDuration(l)),g=s-c;let p=Math.max(e,Math.min(u,g));Number.isFinite(p)||(p=e);const m=Ze*f;p+m<=g&&(p+=m),this.finalPhaseVposOverrides.set(l,p);const v=Math.max(Z,Math.min(c/2,h));u=p+v}),this.finalPhaseScheduleDirty=!1}shouldSuppressRendering(){return!this.playbackHasBegun&&!this.isPlaying&&this.currentTime<=N}updatePlaybackProgressState(){this.playbackHasBegun||(this.isPlaying||this.currentTime>N)&&(this.playbackHasBegun=!0)}updateSettings(e){const t=this._settings.useContainerResizeObserver,s=this._settings.scrollDirection,i=this._settings.useDprScaling,n=this._settings.syncMode;this.settings=e;const a=s!==this._settings.scrollDirection,r=i!==this._settings.useDprScaling,h=n!==this._settings.syncMode;if(this.comments.forEach(u=>{u.syncWithSettings(this._settings,this.settingsVersion)}),a&&this.resetCommentActivity(),!this._settings.isCommentVisible&&this.ctx&&this.canvas){this.comments.forEach(c=>{c.isActive=!1,c.clearActivation()}),this.activeComments.clear();const u=this.canvasDpr>0?this.canvasDpr:1,l=this.displayWidth>0?this.displayWidth:this.canvas.width/u,f=this.displayHeight>0?this.displayHeight:this.canvas.height/u;this.ctx.clearRect(0,0,l,f),this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear()}t!==this._settings.useContainerResizeObserver&&this.videoElement&&this.setupResizeHandling(this.videoElement),r&&this.resize(),h&&this.videoElement&&this.startAnimation()}getVideoElement(){return this.videoElement}getCurrentVideoSource(){const e=this.videoElement;if(!e)return null;if(typeof e.currentSrc=="string"&&e.currentSrc.length>0)return e.currentSrc;const t=e.getAttribute("src");if(t&&t.length>0)return t;const s=e.querySelector("source[src]");return s&&typeof s.src=="string"?s.src:null}getCommentsSnapshot(){return[...this.comments]}rebuildNgMatchers(){const e=[],t=[],s=Array.isArray(this._settings.ngWords)?this._settings.ngWords:[];for(const n of s){if(typeof n!="string")continue;const a=n.trim().toLowerCase();a.length!==0&&e.push(a)}const i=Array.isArray(this._settings.ngRegexps)?this._settings.ngRegexps:[];for(const n of i)if(!(typeof n!="string"||n.length===0))try{t.push(new RegExp(n))}catch(a){this.log.error("CommentRenderer.rebuildNgMatchers.regex",a,{pattern:n})}this.normalizedNgWords=e,this.compiledNgRegexps=t}isNGComment(e){try{if(typeof e!="string")return!0;if(this.normalizedNgWords.length>0){const t=e.toLowerCase();if(this.normalizedNgWords.some(i=>t.includes(i)))return!0}return this.compiledNgRegexps.length>0?this.compiledNgRegexps.some(t=>t.test(e)):!1}catch(t){return this.log.error("CommentRenderer.isNGComment",t,{text:e}),!0}}resize(e,t){const s=this.videoElement,i=this.canvas,n=this.ctx;if(!s||!i)return;const a=s.getBoundingClientRect(),r=this.canvasDpr>0?this.canvasDpr:1,h=this.displayWidth>0?this.displayWidth:i.width/r,u=this.displayHeight>0?this.displayHeight:i.height/r,l=e??a.width??h,f=t??a.height??u;if(!Number.isFinite(l)||!Number.isFinite(f)||l<=0||f<=0)return;const c=Math.max(1,Math.floor(l)),g=Math.max(1,Math.floor(f)),p=this.displayWidth>0?this.displayWidth:c,m=this.displayHeight>0?this.displayHeight:g,v=this._settings.useDprScaling?this.resolveDevicePixelRatio():1,y=Math.max(1,Math.round(c*v)),M=Math.max(1,Math.round(g*v));if(!(this.displayWidth!==c||this.displayHeight!==g||Math.abs(this.canvasDpr-v)>Number.EPSILON||i.width!==y||i.height!==M))return;this.displayWidth=c,this.displayHeight=g,this.canvasDpr=v,i.width=y,i.height=M,i.style.width=`${c}px`,i.style.height=`${g}px`,n&&(n.setTransform(1,0,0,1,0,0),this._settings.useDprScaling&&n.scale(v,v));const b=p>0?c/p:1,C=m>0?g/m:1;(b!==1||C!==1)&&this.comments.forEach(S=>{S.isActive&&(S.x*=b,S.y*=C,S.width*=b,S.fontSize=Math.max(ue,Math.floor(Math.max(1,S.fontSize)*C)),S.height=S.fontSize,S.virtualStartX*=b,S.exitThreshold*=b,S.baseSpeed*=b,S.speed*=b,S.speedPixelsPerMs*=b,S.bufferWidth*=b,S.reservationWidth*=b)}),this.calculateLaneMetrics()}resolveDevicePixelRatio(){if(typeof window>"u")return 1;const e=Number(window.devicePixelRatio);return!Number.isFinite(e)||e<=0?1:e}destroyCanvasOnly(){this.stopAnimation(),this.cleanupResizeHandling(),this.runCleanupTasks(),this.canvas&&this.canvas.remove(),this.canvas=null,this.ctx=null,this.displayWidth=0,this.displayHeight=0,this.canvasDpr=1,this.fullscreenActive=!1}calculateLaneMetrics(){const e=this.canvas;if(!e)return;const t=this.displayHeight>0?this.displayHeight:e.height/Math.max(this.canvasDpr,1),s=Math.max(ue,Math.floor(t*.05));this.laneHeight=s*1.2;const i=Math.floor(t/Math.max(this.laneHeight,1));if(this._settings.useFixedLaneCount){const n=Number.isFinite(this._settings.fixedLaneCount)?Math.floor(this._settings.fixedLaneCount):ce,a=Math.max(he,Math.min(i,n));this.laneCount=a}else this.laneCount=Math.max(he,i);this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear()}updateComments(e){const t=this.videoElement,s=this.canvas,i=this.ctx;if(!t||!s||!i)return;const n=typeof e=="number"?e:D(t.currentTime);if(this.currentTime=n,this.playbackRate=t.playbackRate,this.isPlaying=!t.paused,this.updatePlaybackProgressState(),this.skipDrawingForCurrentFrame=this.shouldSuppressRendering(),this.skipDrawingForCurrentFrame)return;const a=this.canvasDpr>0?this.canvasDpr:1,r=this.displayWidth>0?this.displayWidth:s.width/a,h=this.displayHeight>0?this.displayHeight:s.height/a,u=this.buildPrepareOptions(r),l=this.duration>0&&this.duration-this.currentTime<=Je;l&&!this.finalPhaseActive&&(this.finalPhaseActive=!0,this.finalPhaseStartTime=this.currentTime,this.finalPhaseVposOverrides.clear(),this.finalPhaseScheduleDirty=!0,i.clearRect(0,0,r,h),this.comments.forEach(c=>{c.isActive=!1,c.clearActivation()}),this.activeComments.clear(),this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear()),!l&&this.finalPhaseActive&&this.resetFinalPhaseState(),this.finalPhaseActive&&this.finalPhaseScheduleDirty&&this.recomputeFinalPhaseTimeline(),this.pruneStaticLaneReservations(this.currentTime);const f=this.getCommentsInTimeWindow(this.currentTime,V);for(const c of f){const g=E(),p=g?P(c.text):"";if(g&&w("comment-evaluate",{stage:"update",preview:p,vposMs:c.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(c),currentTime:this.currentTime,isActive:c.isActive,hasShown:c.hasShown}),this.isNGComment(c.text)){g&&w("comment-eval-skip",{preview:p,vposMs:c.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(c),reason:"ng-runtime"});continue}if(c.isInvisible){g&&w("comment-eval-skip",{preview:p,vposMs:c.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(c),reason:"invisible"}),c.isActive=!1,this.activeComments.delete(c),c.hasShown=!0,c.clearActivation();continue}if(c.syncWithSettings(this._settings,this.settingsVersion),this.shouldActivateCommentAtTime(c,this.currentTime,p)&&this.activateComment(c,i,r,h,u,this.currentTime),c.isActive){if(c.layout!=="naka"&&c.hasStaticExpired(this.currentTime)){const m=c.layout==="ue"?"ue":"shita";this.releaseStaticLane(m,c.lane),c.isActive=!1,this.activeComments.delete(c),c.clearActivation();continue}if(c.layout==="naka"&&this.getEffectiveCommentVpos(c)>this.currentTime+N){c.x=c.virtualStartX,c.lastUpdateTime=this.timeSource.now();continue}if(c.hasShown=!0,c.update(this.playbackRate,!this.isPlaying),!c.isScrolling&&c.hasStaticExpired(this.currentTime)){const m=c.layout==="ue"?"ue":"shita";this.releaseStaticLane(m,c.lane),c.isActive=!1,this.activeComments.delete(c),c.clearActivation()}}}for(const c of this.comments)c.isActive&&c.isScrolling&&(c.scrollDirection==="rtl"&&c.x<=c.exitThreshold||c.scrollDirection==="ltr"&&c.x>=c.exitThreshold)&&(c.isActive=!1,this.activeComments.delete(c),c.clearActivation())}buildPrepareOptions(e){const t=this._settings.scrollVisibleDurationMs;let s=ee,i=le;return t!==null&&(s=t,i=Math.max(1,Math.min(t,le))),{visibleWidth:e,virtualExtension:Qe,maxVisibleDurationMs:s,minVisibleDurationMs:i,maxWidthRatio:Ge,bufferRatio:qe,baseBufferPx:Ye,entryBufferPx:Ke}}findAvailableLane(e){const t=this.currentTime;this.pruneLaneReservations(t),this.pruneStaticLaneReservations(t);const s=this.getLanePriorityOrder(t),i=this.createLaneReservation(e,t);for(const a of s)if(this.isLaneAvailable(a,i,t))return this.storeLaneReservation(a,i),a;const n=s[0]??0;return this.storeLaneReservation(n,i),n}findFirstValidReservationIndex(e,t){let s=0,i=e.length;for(;s<i;){const n=Math.floor((s+i)/2),a=e[n];a!==void 0&&a.totalEndTime+j<=t?s=n+1:i=n}return s}pruneLaneReservations(e){for(const[t,s]of this.reservedLanes.entries()){const i=this.findFirstValidReservationIndex(s,e);i>=s.length?this.reservedLanes.delete(t):i>0&&this.reservedLanes.set(t,s.slice(i))}}pruneStaticLaneReservations(e){for(const[t,s]of this.topStaticLaneReservations.entries())s<=e&&this.topStaticLaneReservations.delete(t);for(const[t,s]of this.bottomStaticLaneReservations.entries())s<=e&&this.bottomStaticLaneReservations.delete(t)}findCommentIndexAtOrAfter(e){let t=0,s=this.comments.length;for(;t<s;){const i=Math.floor((t+s)/2),n=this.comments[i];n!==void 0&&n.vposMs<e?t=i+1:s=i}return t}getCommentsInTimeWindow(e,t){if(this.comments.length===0)return[];const s=e-t,i=e+t,n=this.findCommentIndexAtOrAfter(s),a=[];for(let r=n;r<this.comments.length;r++){const h=this.comments[r];if(h===void 0||h.vposMs>i)break;a.push(h)}return a}getStaticLaneMap(e){return e==="ue"?this.topStaticLaneReservations:this.bottomStaticLaneReservations}getStaticReservedLaneSet(){const e=new Set;for(const t of this.topStaticLaneReservations.keys())e.add(t);for(const t of this.bottomStaticLaneReservations.keys())e.add(t);return e}shouldActivateCommentAtTime(e,t,s=""){const i=s.length>0&&E(),n=this.resolveFinalPhaseVpos(e);return this.finalPhaseActive&&this.finalPhaseStartTime!==null&&e.vposMs<this.finalPhaseStartTime-T?(i&&w("comment-eval-skip",{preview:s,vposMs:e.vposMs,effectiveVposMs:n,reason:"final-phase-trimmed",finalPhaseStartTime:this.finalPhaseStartTime}),this.finalPhaseVposOverrides.delete(e),!1):e.isInvisible?(i&&w("comment-eval-skip",{preview:s,vposMs:e.vposMs,effectiveVposMs:n,reason:"invisible"}),!1):e.isActive?(i&&w("comment-eval-skip",{preview:s,vposMs:e.vposMs,effectiveVposMs:n,reason:"already-active"}),!1):n>t+N?(i&&w("comment-eval-pending",{preview:s,vposMs:e.vposMs,effectiveVposMs:n,reason:"future",currentTime:t}),!1):n<t-V?(i&&w("comment-eval-skip",{preview:s,vposMs:e.vposMs,effectiveVposMs:n,reason:"expired-window",currentTime:t}),!1):(i&&w("comment-eval-ready",{preview:s,vposMs:e.vposMs,effectiveVposMs:n,currentTime:t}),!0)}activateComment(e,t,s,i,n,a){e.prepare(t,s,i,n);const r=this.resolveFinalPhaseVpos(e);if(E()&&w("comment-prepared",{preview:P(e.text),layout:e.layout,isScrolling:e.isScrolling,width:e.width,height:e.height,bufferWidth:e.bufferWidth,visibleDurationMs:e.visibleDurationMs,effectiveVposMs:r}),e.layout==="naka"){const f=Math.max(0,a-r),c=e.speedPixelsPerMs*f;if(this.finalPhaseActive&&this.finalPhaseStartTime!==null){const M=this.duration>0?this.duration:this.finalPhaseStartTime+$,x=Math.max(this.finalPhaseStartTime+$,M),b=Math.abs(e.exitThreshold-e.virtualStartX),C=x-r;if(C>0&&b>0){const S=b/C;S>e.speedPixelsPerMs&&(e.speedPixelsPerMs=S,e.baseSpeed=S*(1e3/60),e.speed=e.baseSpeed,e.totalDurationMs=Math.ceil(b/S))}}const g=e.getDirectionSign(),p=e.virtualStartX+g*c,m=e.exitThreshold,v=e.scrollDirection;if(v==="rtl"&&p<=m||v==="ltr"&&p>=m){e.isActive=!1,this.activeComments.delete(e),e.hasShown=!0,e.clearActivation(),e.lane=-1,E()&&w("comment-skip-exited",{preview:P(e.text),vposMs:e.vposMs,effectiveVposMs:r,referenceTime:a});return}e.lane=this.findAvailableLane(e),e.y=e.lane*this.laneHeight,e.x=p,e.isActive=!0,this.activeComments.add(e),e.hasShown=!0,e.isPaused=!this.isPlaying,e.markActivated(a),e.lastUpdateTime=this.timeSource.now(),E()&&w("comment-activate-scroll",{preview:P(e.text),lane:e.lane,startX:e.x,width:e.width,visibleDurationMs:e.visibleDurationMs,effectiveVposMs:r});return}const h=r+I;if(a>h){e.isActive=!1,this.activeComments.delete(e),e.hasShown=!0,e.clearActivation(),e.lane=-1,E()&&w("comment-skip-expired",{preview:P(e.text),vposMs:e.vposMs,effectiveVposMs:r,referenceTime:a,displayEnd:h});return}const u=e.layout==="ue"?"ue":"shita",l=this.assignStaticLane(u);e.lane=l,e.y=l*this.laneHeight,e.x=e.virtualStartX,e.isActive=!0,this.activeComments.add(e),e.hasShown=!0,e.isPaused=!this.isPlaying,e.markActivated(a),e.lastUpdateTime=this.timeSource.now(),e.staticExpiryTimeMs=h,this.reserveStaticLane(u,l,h),E()&&w("comment-activate-static",{preview:P(e.text),lane:e.lane,position:u,displayEnd:h,effectiveVposMs:r})}assignStaticLane(e){const t=this.getStaticLaneMap(e),s=Array.from({length:this.laneCount},(a,r)=>r);e==="shita"&&s.reverse();for(const a of s)if(!t.has(a))return a;let i=s[0]??0,n=Number.POSITIVE_INFINITY;for(const[a,r]of t.entries())r<n&&(n=r,i=a);return i}reserveStaticLane(e,t,s){this.getStaticLaneMap(e).set(t,s)}releaseStaticLane(e,t){if(t<0)return;this.getStaticLaneMap(e).delete(t)}getLanePriorityOrder(e){const s=Array.from({length:this.laneCount},(r,h)=>h).sort((r,h)=>{const u=this.getLaneNextAvailableTime(r,e),l=this.getLaneNextAvailableTime(h,e);return Math.abs(u-l)<=T?r-h:u-l}),i=this.getStaticReservedLaneSet();if(i.size===0)return s;const n=s.filter(r=>!i.has(r));if(n.length===0)return s;const a=s.filter(r=>i.has(r));return[...n,...a]}getLaneNextAvailableTime(e,t){const s=this.reservedLanes.get(e);if(!s||s.length===0)return t;const i=this.findFirstValidReservationIndex(s,t);let n=t;for(let a=i;a<s.length;a++){const r=s[a];r!==void 0&&(n=Math.max(n,r.endTime))}return n}createLaneReservation(e,t){const s=Math.max(e.speedPixelsPerMs,T),i=this.getEffectiveCommentVpos(e),n=Number.isFinite(i)?i:t,a=Math.max(0,n),r=a+e.preCollisionDurationMs+j,h=a+e.totalDurationMs+j;return{comment:e,startTime:a,endTime:Math.max(a,r),totalEndTime:Math.max(a,h),startLeft:e.virtualStartX,width:e.width,speed:s,buffer:e.bufferWidth,directionSign:e.getDirectionSign()}}isLaneAvailable(e,t,s){const i=this.reservedLanes.get(e);if(!i||i.length===0)return!0;const n=this.findFirstValidReservationIndex(i,s);for(let a=n;a<i.length;a++){const r=i[a];if(r===void 0)break;if(this.areReservationsConflicting(r,t))return!1}return!0}storeLaneReservation(e,t){const i=[...this.reservedLanes.get(e)??[],t].sort((n,a)=>n.totalEndTime-a.totalEndTime);this.reservedLanes.set(e,i)}areReservationsConflicting(e,t){const s=Math.max(e.startTime,t.startTime),i=Math.min(e.endTime,t.endTime);if(s>=i)return!1;const n=new Set([s,i,s+(i-s)/2]),a=this.solveLeftRightEqualityTime(e,t);a!==null&&a>=s-T&&a<=i+T&&n.add(a);const r=this.solveLeftRightEqualityTime(t,e);r!==null&&r>=s-T&&r<=i+T&&n.add(r);for(const h of n){if(h<s-T||h>i+T)continue;const u=this.computeForwardGap(e,t,h),l=this.computeForwardGap(t,e,h);if(u<=T&&l<=T)return!0}return!1}computeForwardGap(e,t,s){const i=this.getBufferedEdges(e,s),n=this.getBufferedEdges(t,s);return i.left-n.right}getBufferedEdges(e,t){const s=Math.max(0,t-e.startTime),i=e.speed*s,n=e.startLeft+e.directionSign*i,a=n-e.buffer,r=n+e.width+e.buffer;return{left:a,right:r}}solveLeftRightEqualityTime(e,t){const s=e.directionSign,i=t.directionSign,n=i*t.speed-s*e.speed;if(Math.abs(n)<T)return null;const r=(t.startLeft+i*t.speed*t.startTime+t.width+t.buffer-e.startLeft-s*e.speed*e.startTime+e.buffer)/n;return Number.isFinite(r)?r:null}draw(){const e=this.canvas,t=this.ctx;if(!e||!t)return;const s=this.canvasDpr>0?this.canvasDpr:1,i=this.displayWidth>0?this.displayWidth:e.width/s,n=this.displayHeight>0?this.displayHeight:e.height/s,a=this.timeSource.now();if(this.skipDrawingForCurrentFrame||this.shouldSuppressRendering()){t.clearRect(0,0,i,n),this.lastDrawTime=a;return}t.clearRect(0,0,i,n);const r=Array.from(this.activeComments);if(this._settings.isCommentVisible){const h=(a-this.lastDrawTime)/16.666666666666668;r.sort((u,l)=>{const f=this.getEffectiveCommentVpos(u),c=this.getEffectiveCommentVpos(l),g=f-c;return Math.abs(g)>T?g:u.isScrolling!==l.isScrolling?u.isScrolling?1:-1:u.creationIndex-l.creationIndex}),r.forEach(u=>{const f=this.isPlaying&&!u.isPaused?u.x+u.getDirectionSign()*u.speed*h:u.x;u.draw(t,f)})}this.lastDrawTime=a}processFrame(e){this.videoElement&&this._settings.isCommentVisible&&(this.updateComments(e),this.draw())}handleAnimationFrame=()=>{const e=this.frameId;this.frameId=null,e!==null&&this.animationFrameProvider.cancel(e),this.processFrame(),this.scheduleNextFrame()};handleVideoFrame=(e,t)=>{this.videoFrameHandle=null;const s=typeof t?.mediaTime=="number"?t.mediaTime*1e3:void 0;this.processFrame(typeof s=="number"?s:void 0),this.scheduleNextFrame()};shouldUseVideoFrameCallback(){if(this._settings.syncMode!=="video-frame")return!1;const e=this.videoElement;return!!e&&typeof e.requestVideoFrameCallback=="function"&&typeof e.cancelVideoFrameCallback=="function"}scheduleNextFrame(){const e=this.videoElement;if(e){if(this.shouldUseVideoFrameCallback()){this.cancelAnimationFrameRequest(),this.cancelVideoFrameCallback();const t=e.requestVideoFrameCallback;typeof t=="function"&&(this.videoFrameHandle=t.call(e,this.handleVideoFrame));return}this.cancelVideoFrameCallback(),this.frameId=this.animationFrameProvider.request(this.handleAnimationFrame)}}cancelAnimationFrameRequest(){this.frameId!==null&&(this.animationFrameProvider.cancel(this.frameId),this.frameId=null)}cancelVideoFrameCallback(){if(this.videoFrameHandle===null)return;const e=this.videoElement;e&&typeof e.cancelVideoFrameCallback=="function"&&e.cancelVideoFrameCallback(this.videoFrameHandle),this.videoFrameHandle=null}startAnimation(){this.stopAnimation(),this.scheduleNextFrame()}stopAnimation(){this.cancelAnimationFrameRequest(),this.cancelVideoFrameCallback()}onSeek(){const e=this.canvas,t=this.ctx,s=this.videoElement;if(!e||!t||!s)return;const i=D(s.currentTime);this.currentTime=i,this.resetFinalPhaseState(),this.updatePlaybackProgressState(),this.activeComments.clear(),this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear();const n=this.canvasDpr>0?this.canvasDpr:1,a=this.displayWidth>0?this.displayWidth:e.width/n,r=this.displayHeight>0?this.displayHeight:e.height/n,h=this.buildPrepareOptions(a);this.getCommentsInTimeWindow(this.currentTime,V).forEach(l=>{const f=E(),c=f?P(l.text):"";if(f&&w("comment-evaluate",{stage:"seek",preview:c,vposMs:l.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(l),currentTime:this.currentTime,isActive:l.isActive,hasShown:l.hasShown}),this.isNGComment(l.text)){f&&w("comment-eval-skip",{preview:c,vposMs:l.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(l),reason:"ng-runtime"}),l.isActive=!1,this.activeComments.delete(l),l.clearActivation();return}if(l.isInvisible){f&&w("comment-eval-skip",{preview:c,vposMs:l.vposMs,effectiveVposMs:this.getEffectiveCommentVpos(l),reason:"invisible"}),l.isActive=!1,this.activeComments.delete(l),l.hasShown=!0,l.clearActivation();return}if(l.syncWithSettings(this._settings,this.settingsVersion),l.isActive=!1,this.activeComments.delete(l),l.lane=-1,l.clearActivation(),this.shouldActivateCommentAtTime(l,this.currentTime,c)){this.activateComment(l,t,a,r,h,this.currentTime);return}this.getEffectiveCommentVpos(l)<this.currentTime-V?l.hasShown=!0:l.hasShown=!1}),this._settings.isCommentVisible&&(this.lastDrawTime=this.timeSource.now(),this.draw())}setupVideoEventListeners(e){try{const t=()=>{this.isPlaying=!0,this.playbackHasBegun=!0;const l=this.timeSource.now();this.lastDrawTime=l,this.comments.forEach(f=>{f.lastUpdateTime=l,f.isPaused=!1})},s=()=>{this.isPlaying=!1;const l=this.timeSource.now();this.comments.forEach(f=>{f.lastUpdateTime=l,f.isPaused=!0})},i=()=>{this.onSeek()},n=()=>{this.onSeek()},a=()=>{this.playbackRate=e.playbackRate;const l=this.timeSource.now();this.comments.forEach(f=>{f.lastUpdateTime=l})},r=()=>{this.handleVideoMetadataLoaded(e)},h=()=>{this.duration=Number.isFinite(e.duration)?D(e.duration):0},u=()=>{this.handleVideoSourceChange()};e.addEventListener("play",t),e.addEventListener("pause",s),e.addEventListener("seeking",i),e.addEventListener("seeked",n),e.addEventListener("ratechange",a),e.addEventListener("loadedmetadata",r),e.addEventListener("durationchange",h),e.addEventListener("emptied",u),this.addCleanup(()=>e.removeEventListener("play",t)),this.addCleanup(()=>e.removeEventListener("pause",s)),this.addCleanup(()=>e.removeEventListener("seeking",i)),this.addCleanup(()=>e.removeEventListener("seeked",n)),this.addCleanup(()=>e.removeEventListener("ratechange",a)),this.addCleanup(()=>e.removeEventListener("loadedmetadata",r)),this.addCleanup(()=>e.removeEventListener("durationchange",h)),this.addCleanup(()=>e.removeEventListener("emptied",u))}catch(t){throw this.log.error("CommentRenderer.setupVideoEventListeners",t),t}}handleVideoMetadataLoaded(e){this.handleVideoSourceChange(e),this.resize(),this.calculateLaneMetrics(),this.onSeek()}handleVideoSourceChange(e){const t=e??this.videoElement;if(!t){this.isPlaying=!1,this.resetFinalPhaseState(),this.resetCommentActivity();return}this.syncVideoState(t),this.resetFinalPhaseState(),this.resetCommentActivity()}syncVideoState(e){this.duration=Number.isFinite(e.duration)?D(e.duration):0,this.currentTime=D(e.currentTime),this.playbackRate=e.playbackRate,this.isPlaying=!e.paused,this.playbackHasBegun=this.isPlaying||this.currentTime>N,this.lastDrawTime=this.timeSource.now()}resetCommentActivity(){const e=this.timeSource.now(),t=this.canvas,s=this.ctx;if(this.resetFinalPhaseState(),this.skipDrawingForCurrentFrame=!1,this.playbackHasBegun=this.isPlaying||this.currentTime>N,t&&s){const i=this.canvasDpr>0?this.canvasDpr:1,n=this.displayWidth>0?this.displayWidth:t.width/i,a=this.displayHeight>0?this.displayHeight:t.height/i;s.clearRect(0,0,n,a)}this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear(),this.comments.forEach(i=>{i.isActive=!1,i.isPaused=!this.isPlaying,i.hasShown=!1,i.lane=-1,i.x=i.virtualStartX,i.speed=i.baseSpeed,i.lastUpdateTime=e,i.clearActivation()}),this.activeComments.clear()}setupVideoChangeDetection(e,t){if(typeof MutationObserver>"u"){this.log.debug("MutationObserver is not available in this environment. Video change detection is disabled.");return}const s=new MutationObserver(n=>{for(const a of n){if(a.type==="attributes"&&a.attributeName==="src"){const r=a.target;let h=null,u=null;if((r instanceof HTMLVideoElement||r instanceof HTMLSourceElement)&&(h=typeof a.oldValue=="string"?a.oldValue:null,u=r.getAttribute("src")),h===u)continue;this.handleVideoSourceChange(e);return}if(a.type==="childList"){for(const r of a.addedNodes)if(r instanceof HTMLSourceElement){this.handleVideoSourceChange(e);return}for(const r of a.removedNodes)if(r instanceof HTMLSourceElement){this.handleVideoSourceChange(e);return}}}});s.observe(e,{attributes:!0,attributeFilter:["src"],attributeOldValue:!0,childList:!0,subtree:!0}),this.addCleanup(()=>s.disconnect());const i=new MutationObserver(n=>{for(const a of n)if(a.type==="childList"){for(const r of a.addedNodes){const h=this.extractVideoElement(r);if(h&&h!==this.videoElement){this.initialize(h);return}}for(const r of a.removedNodes){if(r===this.videoElement){this.videoElement=null,this.handleVideoSourceChange(null);return}if(r instanceof Element){const h=r.querySelector("video");if(h&&h===this.videoElement){this.videoElement=null,this.handleVideoSourceChange(null);return}}}}});i.observe(t,{childList:!0,subtree:!0}),this.addCleanup(()=>i.disconnect())}extractVideoElement(e){if(e instanceof HTMLVideoElement)return e;if(e instanceof Element){const t=e.querySelector("video");if(t instanceof HTMLVideoElement)return t}return null}setupVisibilityHandling(){if(typeof document>"u"||typeof document.addEventListener!="function"||typeof document.removeEventListener!="function")return;const e=()=>{if(document.visibilityState!=="visible"){this.stopAnimation();return}this._settings.isCommentVisible&&(this.handleVisibilityRestore(),this.startAnimation())};document.addEventListener("visibilitychange",e),this.addCleanup(()=>document.removeEventListener("visibilitychange",e)),document.visibilityState!=="visible"&&this.stopAnimation()}handleVisibilityRestore(){const e=this.canvas,t=this.ctx,s=this.videoElement;if(!e||!t||!s)return;this.currentTime=D(s.currentTime),this.isPlaying=!s.paused,this.activeComments.clear(),this.reservedLanes.clear(),this.topStaticLaneReservations.clear(),this.bottomStaticLaneReservations.clear();const i=this.canvasDpr>0?this.canvasDpr:1,n=this.displayWidth>0?this.displayWidth:e.width/i,a=this.displayHeight>0?this.displayHeight:e.height/i;t.clearRect(0,0,n,a);const r=this.buildPrepareOptions(n),h=this.timeSource.now();this.getCommentsInTimeWindow(this.currentTime,V).forEach(l=>{if(this.isNGComment(l.text)||l.isInvisible){l.isActive=!1,this.activeComments.delete(l),l.clearActivation();return}l.syncWithSettings(this._settings,this.settingsVersion),l.isActive=!1,this.activeComments.delete(l),l.lane=-1,l.clearActivation(),l.lastUpdateTime=h,this.shouldActivateCommentAtTime(l,this.currentTime)&&this.activateComment(l,t,n,a,r,this.currentTime);const f=this.getEffectiveCommentVpos(l);f<this.currentTime-V?l.hasShown=!0:f>this.currentTime&&(l.hasShown=!1)}),this.lastDrawTime=h}setupResizeHandling(e){if(this.cleanupResizeHandling(),this._settings.useContainerResizeObserver&&this.isResizeObserverAvailable){const t=this.resolveResizeObserverTarget(e),s=new ResizeObserver(i=>{for(const n of i){const{width:a,height:r}=n.contentRect;a>0&&r>0?this.resize(a,r):this.resize()}});s.observe(t),this.resizeObserver=s,this.resizeObserverTarget=t}else if(typeof window<"u"&&typeof window.addEventListener=="function"){const t=()=>{this.resize()};window.addEventListener("resize",t),this.addCleanup(()=>window.removeEventListener("resize",t))}else this.log.debug("Resize handling is disabled because neither ResizeObserver nor window APIs are available.")}cleanupResizeHandling(){this.resizeObserver&&this.resizeObserverTarget&&this.resizeObserver.unobserve(this.resizeObserverTarget),this.resizeObserver?.disconnect(),this.resizeObserver=null,this.resizeObserverTarget=null}setupFullscreenHandling(){if(typeof document>"u"||typeof document.addEventListener!="function"||typeof document.removeEventListener!="function")return;const e=()=>{this.handleFullscreenChange()};["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"].forEach(s=>{document.addEventListener(s,e),this.addCleanup(()=>document.removeEventListener(s,e))}),this.handleFullscreenChange()}resolveResizeObserverTarget(e){const t=this.resolveFullscreenContainer(e);return t||(e.parentElement??e)}async handleFullscreenChange(){const e=this.canvas,t=this.videoElement;if(!e||!t)return;const s=this.containerElement??t.parentElement??null,i=this.getFullscreenElement(),n=this.resolveActiveOverlayContainer(t,s,i);if(!(n instanceof HTMLElement))return;e.parentElement!==n?(this.ensureContainerPositioning(n),n.appendChild(e)):this.ensureContainerPositioning(n);const r=(i instanceof HTMLElement&&i.contains(t)?i:null)!==null;this.fullscreenActive!==r&&(this.fullscreenActive=r,this.setupResizeHandling(t)),e.style.position="absolute",e.style.top="0",e.style.left="0",this.resize()}resolveFullscreenContainer(e){const t=this.getFullscreenElement();return t instanceof HTMLElement&&(t===e||t.contains(e))?t:null}resolveActiveOverlayContainer(e,t,s){return s instanceof HTMLElement&&s.contains(e)?s instanceof HTMLVideoElement&&t instanceof HTMLElement?t:s:t??null}getFullscreenElement(){if(typeof document>"u")return null;const e=document;return document.fullscreenElement??e.webkitFullscreenElement??e.mozFullScreenElement??e.msFullscreenElement??null}addCleanup(e){this.cleanupTasks.push(e)}runCleanupTasks(){for(;this.cleanupTasks.length>0;){const e=this.cleanupTasks.pop();try{e?.()}catch(t){this.log.error("CommentRenderer.cleanupTask",t)}}}}exports.COMMENT_OVERLAY_VERSION=Be;exports.Comment=d;exports.CommentRenderer=st;exports.DEFAULT_RENDERER_SETTINGS=$e;exports.cloneDefaultSettings=ve;exports.configureDebugLogging=pe;exports.createDefaultAnimationFrameProvider=ge;exports.createDefaultTimeSource=se;exports.createLogger=te;exports.debugLog=w;exports.isDebugLoggingEnabled=E;exports.resetDebugCounters=Ve;
//# sourceMappingURL=comment-overlay.cjs.map
